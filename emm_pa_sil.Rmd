---
title: "emm_pa_sil"
author: "Minghui Wang"
date: "2025-03-27"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(tidyverse)
library(survival)
library(mice)
library(dplyr)
library(purrr)
library(survival)
library(readr)
library(tableone)
library(forestplot)
library(coxme)
```

1周3次以上


# 2008–2018 for HRS (waves 9–14), 

## Data Import

PS: Data from 2019 onward include the COVID-19 period, which represents a major confounding factor in our study.

This population-based, cross-national cohort study used longitudinal data from three cohorts of adults aged 60 years and older: HRS, ELSA, and MHAS. These cohorts included data on participants' physical activities, social activities, loneliness, and depressive symptoms. To ensure comparability across surveys, we analyzed data from similar time periods: 2008–2018 for HRS (waves 9–14), 2010–2018 for ELSA (waves 5–9), and 2012–2018 for MHAS (waves 3–5).

```{r}
HRS_raw = read_sav("./data/HRS/randhrs1992_2020v2.sav")

```

### Load wave 9 data
```{r}

library(SAScii) 

# 设置文件路径（请替换为您的实际路径）
fn = "./data/HRS/h08core/h08da/H08LB_R.da"  
sas.input <- "./data/HRS/h08core/h08sas/H08LB_R.sas"
x <- read.SAScii( fn , sas.input )

```

```{r}
social_isolation_df <- x |>
  mutate(
    # 1. 未婚/独居
    unmarried_alone = case_when(
      LLB004 == 5 ~ 1,
      !is.na(LLB004) ~ 0,
      TRUE ~ NA_real_
    ),
    
    # 2. 与子女联系少于每月一次
    less_child_contact = case_when(
      # 任何一个变量>=4或全部缺失
      (LLB009A >= 4 | is.na(LLB009A)) & 
      (LLB009B >= 4 | is.na(LLB009B)) & 
      (LLB009C >= 4 | is.na(LLB009C)) &
      !(is.na(LLB009A) & is.na(LLB009B) & is.na(LLB009C)) ~ 1,
      # 至少有一个变量<4
      LLB009A < 4 | LLB009B < 4 | LLB009C < 4 ~ 0,
      TRUE ~ NA_real_
    ),
    
    # 3. 与其他家庭成员联系少于每月一次
    less_family_contact = case_when(
      (LLB013A >= 4 | is.na(LLB013A)) & 
      (LLB013B >= 4 | is.na(LLB013B)) & 
      (LLB013C >= 4 | is.na(LLB013C)) &
      !(is.na(LLB013A) & is.na(LLB013B) & is.na(LLB013C)) ~ 1,
      LLB013A < 4 | LLB013B < 4 | LLB013C < 4 ~ 0,
      TRUE ~ NA_real_
    ),
    
    # 4. 与朋友联系少于每月一次
    less_friends_contact = case_when(
      (LLB017A >= 4 | is.na(LLB017A)) & 
      (LLB017B >= 4 | is.na(LLB017B)) & 
      (LLB017C >= 4 | is.na(LLB017C)) &
      !(is.na(LLB017A) & is.na(LLB017B) & is.na(LLB017C)) ~ 1,
      LLB017A < 4 | LLB017B < 4 | LLB017C < 4 ~ 0,
      TRUE ~ NA_real_
    ),
    
    # 5. 不参加每月的社交组织活动
    no_social_participation = case_when(
      # 如果有任何一个变量是1或2，说明参与了社交活动
      (LLB001B %in% c(1, 2) & !is.na(LLB001B)) | 
      (LLB001C %in% c(1, 2) & !is.na(LLB001C)) | 
      (LLB001E %in% c(1, 2) & !is.na(LLB001E)) | 
      (LLB001F %in% c(1, 2) & !is.na(LLB001F)) | 
      (LLB001J %in% c(1, 2) & !is.na(LLB001J)) ~ 0,
      # 如果所有非NA变量都不是1或2，且至少有一个非NA变量
      !all(is.na(c(LLB001B, LLB001C, LLB001E, LLB001F, LLB001J))) ~ 1,
      TRUE ~ NA_real_
    )
  ) |>
  # 计算非NA组件的总和
  rowwise() |>
  mutate(
    # 计算有多少个非NA的社交隔离指标
    valid_components = sum(!is.na(c(unmarried_alone, less_child_contact, 
                                    less_family_contact, less_friends_contact, 
                                    no_social_participation))),
    
    # 计算可用的社交隔离分数
    sum_valid = sum(c(unmarried_alone, less_child_contact, 
                      less_family_contact, less_friends_contact, 
                      no_social_participation), na.rm = TRUE),
    
    # 如果至少有3个有效指标，则计算社交隔离指数
    social_isolation_index = case_when(
      valid_components >= 3 ~ sum_valid,
      TRUE ~ NA_real_
    ),
    
    # 分类变量：2分及以上为社交隔离
    social_isolation = ifelse(social_isolation_index >= 2, 1, 0)
  ) |>
  ungroup() |>
  # 选择需要的列
  select(HHID, social_isolation_index, social_isolation) |>
  # 移除仍然有NA的行
  filter(!is.na(social_isolation))
  
```

Criterion	Description	Variable to Use
(1) were unmarried/living alone: LLB004 
(2) had less than monthly contact with children (all contacts, including face-to-face meet up, speak on the phone, write, or email): LB009A ,LLB009B,LLB009C
(3) had less than monthly contact with other family members:LLB013A, LLB013B, LLB013C
(4) had less than monthly contact with friends: LLB017A, LLB017B,LLB017C
(5) did not participate monthly in any groups, clubs, or other social organizations:  LLB001B ,LLB001C, LLB001E, LLB001F, LLB001J


## Data Cleaning
We included participants aged 60 and older who had reported data on physical activities, social activities, and loneliness at baseline and had been assessed at least twice. We excluded those with depressive symptoms at baseline, those with missing data on depressive symptoms or covariates, and those lost to follow-up. Participants were followed from their first assessment until the study outcome occurred, their last valid follow-up questionnaire, or the end of the study period, whichever came first. The estimated sample size is around 16,000.

```{r}
# Select columns starting with R9, R10, R11, R12, R13, and R4, plus HHIDPN
all_cols <- names(HRS_raw)
r_cols <- all_cols[grepl("^R(9|10|11|12|13|14)", all_cols)]

# 选择 S9 wave 的关键 demographic 变量
s_baseline_cols <- c(
  "RAGENDER", "RAEDUC", "RAHISPAN", "RARACEM",  # 性别、教育、种族
  "RABMONTH", "RABYEAR", "RAEDYRS", "RAEDEGRM" # 出生月年、教育年数、学位
)

selected_cols <- c("HHIDPN", s_baseline_cols, r_cols)

# Create the new dataframe with selected columns
HRS_9_14 <- HRS_raw[, selected_cols] |>
  filter(R9IWSTAT == 1 | R10IWSTAT == 1 | R11IWSTAT == 1 |
         R12IWSTAT == 1 | R13IWSTAT == 1 | R14IWSTAT == 1)

```

28575 unique individuals in HRA from 2008 to 2018 (waves 9–14)


```{r}
HRS_9_14_inclusion = HRS_9_14 |>
  #Age < 55
    mutate(
    estimated_age_at_R9 = case_when(
      !is.na(R9AGEY_E) ~ R9AGEY_E,
      !is.na(R10AGEY_E) ~ R10AGEY_E - 2,
      !is.na(R11AGEY_E) ~ R11AGEY_E - 4,
      !is.na(R12AGEY_E) ~ R12AGEY_E - 6,
      !is.na(R13AGEY_E) ~ R13AGEY_E - 8,
      !is.na(R14AGEY_E) ~ R14AGEY_E - 10,
      TRUE ~ NA_real_
    )
  )|>
  filter( estimated_age_at_R9 >= 55)|>
# information of depression: NA or Yes
  filter(!is.na(R9CESD))|>
  filter(R9CESD < 2)|>
# Any missing data in baseline characteristics
  
  filter(
     #!is.na(R9SOCGRP),  Social activities
    !is.na(R9FLONE), #  felt loneliness
    !is.na(RAGENDER),# sex
    !is.na(R9MSTAT),# marital status
    !is.na(RAEDUC),# Education
    !is.na(R9FINR), # Family income
    !is.na(R9LBRF), # Employment status
    !is.na(R9BMI),#BMI

    !is.na(R9DRINK))|># Alcohol consumption
    #PA
  mutate(across(
    .cols = c(R9VGACTX, R9MDACTX),
    .fns = ~ if_else(. %in% c('.D', '.J', '.M', '.R'), NA_real_, as.numeric(.))
  )) %>%
  # 2. 分别将“1,2,3=活跃(0)；4,5=不活跃(1)”进行二值转换
  mutate(
    physical_activity_binary = case_when(
      R9VGACTX %in% c(1, 2) ~ 1,  
      R9VGACTX %in% c(3, 4, 5) ~ 0, 
      TRUE ~ NA_real_
    ),
    vigor_pa = factor(
      physical_activity_binary,
      levels = c(0, 1),
      labels = c("No", "Yes")
    )
  )|> 
  # smoking
    mutate(
    Smoking = case_when(
      # 当前吸烟者(Current smoker)
      R9SMOKEN == 1 ~ "Current smoker",
      
      # 曾经吸烟但现在不吸烟者(Past smoker)
      R9SMOKEN == 0 & R9SMOKEV == 1 ~ "Past smoker",
      
      # 从不吸烟者(Non-smoker)
      R9SMOKEN == 0 & R9SMOKEV == 0 ~ "Non-smoker",
      
      # 处理缺失值
      TRUE ~ NA_character_
    )
  )|>
    # NCDs
     mutate(
    ncd_count = rowSums(
      cbind(
        R9HIBP,    # Hypertension
        R9HEART,   # Heart disease
        R9STROKE,  # Stroke
        R9DIAB,    # Diabetes
        R9LUNG,    # Lung disease (e.g., COPD)
        R9CANCR,   # Cancer
        R9ARTHR    # Arthritis
      ) == 1,      # Count only positive responses
      na.rm = TRUE
    )
  ) |>
   filter(!is.na(ncd_count),!is.na(Smoking), !is.na(vigor_pa))

```

```{r}
# 第1步：从HHIDPN中提取HHID和PN
hhid_pn_mapping <- HRS_9_14_inclusion |>
  mutate(
    HHID = floor(HHIDPN / 1000),
    PN = HHIDPN %% 1000
  ) |>
  select(HHIDPN, HHID, PN) |>
  distinct()

# 第2步：将social_isolation_df中的HHID扩展为HHIDPN
social_isolation_with_pn <- social_isolation_df |>
  # 确保HHID是字符型（如果需要）
  mutate(HHID = as.numeric(HHID)) |>
  # 与HHID-PN映射表合并
  inner_join(hhid_pn_mapping, by = "HHID") |>
  # 选择需要的列
  select(HHIDPN, social_isolation_index, social_isolation)

# 第3步：将扩展后的社交隔离数据与原始数据集合并
HRS_9_14_inclusion_sii <- HRS_9_14_inclusion |>
  left_join(social_isolation_with_pn, by = "HHIDPN")|>
  filter(
    !is.na(social_isolation)
  )

# 检查合并结果
dim(HRS_9_14_inclusion_sii)

```



```{r}
HRS_9_14_inclusion_final <- HRS_9_14_inclusion_sii %>%
  rowwise() %>%
  mutate(num_cesd_waves = sum(!is.na(c_across(starts_with("R") & ends_with("CESD"))))) %>%
  ungroup() %>%
  filter(num_cesd_waves >= 2)  # 至少2次CES-D测量

dim(HRS_9_14_inclusion_final)

```
- Age < 55:  11247 (18471)
- information of depression: NA : 2440 (16031)
- information of depression: Yes: 3515 (14918)
**Participants without Depression at baseline: 14918 **

- Any missing data in baseline characteristics
- Lost to follow up or interviewed only once

**Participants included at baseline: 6829**

## Select desired Variables

```{r}
HRS_9_14_inclusion_final_df = HRS_9_14_inclusion_final|>
  select(
      HHIDPN,
      #Exposure
      social_isolation, # social isolation
      #lonely
      R9FLONE,R9LBLONELY3,
      # Outcomes:
      R9CESD,R10CESD,R11CESD,R12CESD,R13CESD,R14CESD, #depression
      #EMM: 
      vigor_pa,
      # Baseline characteristics
      estimated_age_at_R9, # Median age (IQR), years
      RAGENDER,# Sex
      R9MSTAT,# Marital status
      RAEDUC,# Education
      RARACEM,RAHISPAN, #Race
      R9FINR, # Family income
      R9LBRF, # Employment status
      R9BMI,#BMI
      Smoking,# Smoking
      R9DRINK,# Alcohol consumption
      ncd_count) |># NCDs
    rename(
        # Baseline characteristics
        "Age" = estimated_age_at_R9,
        "Sex" = RAGENDER,
        "Marital_status" = R9MSTAT,
        "Education" = RAEDUC,
        "Family_income" = R9FINR,
        "Employment_status" = R9LBRF,
        "BMI" = R9BMI,
        "Alcohol_consumption" = R9DRINK,
        "Non_communicable_diseases" = ncd_count
      )|>
  #lonely
   mutate(
    # 处理三项 R-UCLA 平均分：
    # 先将平均分乘以 3，得到各题得分之和（范围 3～9），
    # 如果乘3后的值 ≥ 4 则认定为孤独（1），否则为不孤独（0）。
    lonely_three = case_when(
      !is.na(R9LBLONELY3) ~ if_else(R9LBLONELY3 * 3 >= 4, 1, 0),
      TRUE ~ NA_real_
    ),
    # 处理单项测量变量 R9FLONE：
    # 若 R9FLONE ≥ 1 则认定为孤独（1），否则为不孤独（0）
    lonely_single = case_when(
      !is.na(R9FLONE) ~ if_else(R9FLONE >= 1, 1, 0),
      TRUE ~ NA_real_
    ),
    # 综合两种测量：
    # 若任一指标有效且为 1，则最终判定为孤独；
    # 若两项均有效且均为 0，则判定为不孤独；
    # 若其中一项缺失，则采用有效项的结果；若两项均缺失则为 NA。
    Loneliness = case_when(
      (!is.na(lonely_three) & lonely_three == 1) | (!is.na(lonely_single) & lonely_single == 1) ~ 1,
      !is.na(lonely_three) & !is.na(lonely_single) & lonely_three == 0 & lonely_single == 0 ~ 0,
      !is.na(lonely_three) & is.na(lonely_single) ~ lonely_three,
      is.na(lonely_three) & !is.na(lonely_single) ~ lonely_single,
      TRUE ~ NA_real_
    )
  )|>
    # RACE
     mutate(
        race = case_when(
          # Missing if either variable is missing
          is.na(RARACEM) | is.na(RAHISPAN) ~ "Missing",
          
          # Hispanic (any race)
          RAHISPAN == 1 ~ "non-White",
          
          # Non-Hispanic by race
          RAHISPAN == 0 & RARACEM == 1 ~ "White",
          RAHISPAN == 0 & RARACEM %in% c(2, 3, 4, 5, 6, 7) ~ "non-White", # Assuming other race codes
          
          # Default case
          TRUE ~ "Other"
        )
      ) |>
      # Convert to factor with specified levels
      mutate(
        race = factor(race, 
                      levels = c("White", "non-White"))
      )
```


Create df for cox analysis

```{r}
# Create variables for Cox regression analysis
HRS_9_14_inclusion_cox_df = HRS_9_14_inclusion_final_df |>
  mutate(
    depression_event = case_when(
      # Check for depression in any follow-up wave
      ((!is.na(R10CESD) & R10CESD >= 2) | 
       (!is.na(R11CESD) & R11CESD >= 2) | 
       (!is.na(R12CESD) & R12CESD >= 2) | 
       (!is.na(R13CESD) & R13CESD >= 2) | 
       (!is.na(R14CESD) & R14CESD >= 2)) ~ 1,
      # Otherwise censored
      TRUE ~ 0
    ),
    follow_up_time = case_when(
      depression_event == 1 & R10CESD >= 2 ~ 2,
      depression_event == 1 & R11CESD >= 2 & (is.na(R10CESD) | R10CESD < 2) ~ 4,
      depression_event == 1 & R12CESD >= 2 & (is.na(R11CESD) | R11CESD < 2) ~ 6,
      depression_event == 1 & R13CESD >= 2 & (is.na(R12CESD) | R12CESD < 2) ~ 8,
      depression_event == 1 & R14CESD >= 2 & (is.na(R13CESD) | R13CESD < 2) ~ 10,
      depression_event == 0 & !is.na(R14CESD) ~ 10,
      depression_event == 0 & !is.na(R13CESD) & is.na(R14CESD) ~ 8,
      depression_event == 0 & !is.na(R12CESD) & is.na(R13CESD) ~ 6,
      depression_event == 0 & !is.na(R11CESD) & is.na(R12CESD) ~ 4,
      depression_event == 0 & !is.na(R10CESD) & is.na(R11CESD) ~ 2,
      TRUE ~ NA_real_
    )
  ) |>
  select(-RAHISPAN, -RARACEM, -ends_with("CESD"), -ends_with("ACTX"),  -Family_income) |>
  mutate(
    social_isolation = factor(social_isolation, levels = c(1, 0), labels = c("Yes", "No")),
    Loneliness = factor(Loneliness, levels = c(0, 1), labels = c("Not lonely", "Lonely")),
    Sex = factor(Sex, levels = c(1, 2), labels = c("Male", "Female")),
    Marital_status = factor(Marital_status, levels = c(1,2,3,4,5,6,7,8),
                            labels = c("Married or partnered", "Married or partnered", "Married or partnered", 
                                       "Single", "Single", "Single", "Single", "Single")),
    Education = factor(Education, levels = c(1,2,3,4,5),
                       labels = c("Less than upper secondary", "Upper secondary", "Upper secondary", "Tertiary", "Tertiary")),
    Employment_status = case_when(
      as.character(Employment_status) %in% c("1", "2", "4") ~ "Working",
      as.character(Employment_status) %in% c("5", ".A") ~ "Retired",
      as.character(Employment_status) %in% c("3", "6", "7", ".T", ".Q") ~ "Not working",
      TRUE ~ NA_character_
    ),
    Employment_status = factor(Employment_status, levels = c("Working", "Retired", "Not working")),
    BMI = case_when(
      BMI < 25 ~ "Underweight or healthy weight",
      BMI >= 25 & BMI < 30 ~ "Overweight",
      BMI >= 30 ~ "Obesity"
    ),
    BMI = factor(BMI, levels = c("Underweight or healthy weight", "Overweight", "Obesity")),
    
    Smoking = factor(Smoking),
    
    Alcohol_consumption = factor(Alcohol_consumption, levels = c(0,1), labels = c("No", "Yes")),
    
    Non_communicable_diseases = factor(ifelse(Non_communicable_diseases == 0, "None", "One or more"))
  )


#write.csv(HRS_9_14_inclusion_cox_df, "./data/cleaned/HRS_9_14_cox.csv", row.names = FALSE)
```

## EDA
```{r}
# 安装和加载tableone包
if(!require(tableone)) install.packages("tableone")
library(tableone)

# 定义要包含在表中的变量
vars <- c("Age", "Sex", "race", "Marital_status", "Education", "Employment_status", 
          "BMI", "Smoking", "Alcohol_consumption", "Non_communicable_diseases", 
          "social_isolation", "Loneliness")

# 定义哪些变量是分类变量
categorical_vars <- c("social_isolation","Loneliness", "Sex", "race", "Marital_status", "Education", "Employment_status", 
                     "Smoking", "Alcohol_consumption", "Non_communicable_diseases")

# 创建Table 1
table1_HRS <- CreateTableOne(
  vars = vars,
  strata = "vigor_pa",
  data = HRS_9_14_inclusion_cox_df,
  factorVars = categorical_vars
)
table1_HRS

# 提取为 data.frame
table1_HRS_df <- print(table1_HRS, quote = FALSE, noSpaces = TRUE, printToggle = FALSE)

# 然后写入 CSV
write_csv(as.data.frame(table1_HRS_df), "./data/cleaned/HRS_9_14_table1_generic.csv")

```

```{r}
HRS_9_14_inclusion_cox_df　|>
  select(categorical_vars, vigor_pa)|>
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value")|>
  ggplot(aes(x = factor(Value), fill = Variable)) +
  geom_bar() +
  facet_wrap(~ Variable, scales = "free_x") +
  labs(
    title = "Distribution of Categorical Variables by Category",
    subtitle = "Health and Retirement Study (HRS) Data Analysis",
    x = "Category", 
    y = "Count"
  ) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

```{r}
HRS_9_14_inclusion_cox_df |>
  select(vigor_pa, categorical_vars) |>
  pivot_longer(cols = -vigor_pa, names_to = "Variable", values_to = "Value") |>
  ggplot(aes(x = factor(Value), fill = factor(vigor_pa))) +
  geom_bar(position = "dodge") +   # 改为 "fill" 可以显示比例
  facet_wrap(~ Variable, scales = "free_x") +
  labs(
    title = "Distribution of Categorical Variables by Physical Activity Group",
    subtitle = "Health and Retirement Study (HRS) Data",
    x = "Category", 
    y = "Count",
    fill = "physical Inactivity"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

```
## Cox model
```{r}
hrs_data_std <- HRS_9_14_inclusion_cox_df %>%
  rename(
    id = HHIDPN,
    isolation = social_isolation,
    loneliness = Loneliness,
    age = Age,
    sex = Sex,
    mar_status = Marital_status,
    education = Education,
    employment = Employment_status,
    bmi = BMI,
    smoking = Smoking,
    alcohol = Alcohol_consumption,
    ncd = Non_communicable_diseases,
    event = depression_event,
    time = follow_up_time
  ) %>%
  mutate(data_source = "HRS")
```

### Loneliness
```{r}
# 模型1：仅包含 loneliness 的单变量模型
cox_model_lonely_raw <- coxph(Surv(time, event) ~ loneliness, data = hrs_data_std)

# 模型2：调整协变量模型（不含身体活动）
cox_model_lonely_adj <- coxph(Surv(time, event) ~ loneliness + age + sex + race + mar_status + education + employment +
                              bmi + smoking + alcohol + ncd,
                              data = hrs_data_std)

# 模型3：调整协变量模型，额外加入 vigor_pa 作为共变量
cox_model_lonely_pi <- coxph(Surv(time, event) ~ loneliness + vigor_pa + age + sex + race + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                             data = hrs_data_std)

# 模型4：包含 loneliness 与 vigor_pa 交互项的模型
cox_model_lonely_emm <- coxph(Surv(time, event) ~ loneliness * vigor_pa + age + sex + race + mar_status + education + employment +
                              bmi + smoking + alcohol + ncd,
                              data = hrs_data_std)

```

```{r}
#提取结果

## 模型1结果
summary_lonely_raw <- summary(cox_model_lonely_raw)
hr1      <- summary_lonely_raw$conf.int["lonelinessLonely", "exp(coef)"]
lower1   <- summary_lonely_raw$conf.int["lonelinessLonely", "lower .95"]
upper1   <- summary_lonely_raw$conf.int["lonelinessLonely", "upper .95"]
p1       <- summary_lonely_raw$coefficients["lonelinessLonely", "Pr(>|z|)"]

## 模型2结果
summary_lonely_adj <- summary(cox_model_lonely_adj)
hr2      <- summary_lonely_adj$conf.int["lonelinessLonely", "exp(coef)"]
lower2   <- summary_lonely_adj$conf.int["lonelinessLonely", "lower .95"]
upper2   <- summary_lonely_adj$conf.int["lonelinessLonely", "upper .95"]
p2       <- summary_lonely_adj$coefficients["lonelinessLonely", "Pr(>|z|)"]

## 模型3结果
summary_lonely_pi <- summary(cox_model_lonely_pi)
hr3      <- summary_lonely_pi$conf.int["lonelinessLonely", "exp(coef)"]
lower3   <- summary_lonely_pi$conf.int["lonelinessLonely", "lower .95"]
upper3   <- summary_lonely_pi$conf.int["lonelinessLonely", "upper .95"]
p3       <- summary_lonely_pi$coefficients["lonelinessLonely", "Pr(>|z|)"]

## 模型4结果 - loneliness 主效应
summary_lonely_emm <- summary(cox_model_lonely_emm)
hr4      <- summary_lonely_emm$conf.int["lonelinessLonely", "exp(coef)"]
lower4   <- summary_lonely_emm$conf.int["lonelinessLonely", "lower .95"]
upper4   <- summary_lonely_emm$conf.int["lonelinessLonely", "upper .95"]
p4       <- summary_lonely_emm$coefficients["lonelinessLonely", "Pr(>|z|)"]

## 交互项效果（乘法交互）提取
# 假设交互项名称为 "lonelinessLonely:vigor_paYes"
interaction_term <- "lonelinessLonely:vigor_paYes"
interaction_coef <- summary_lonely_emm$coefficients[interaction_term, "coef"]
interaction_hr   <- summary_lonely_emm$conf.int[interaction_term, "exp(coef)"]
interaction_lower<- summary_lonely_emm$conf.int[interaction_term, "lower .95"]
interaction_upper<- summary_lonely_emm$conf.int[interaction_term, "upper .95"]
interaction_p    <- summary_lonely_emm$coefficients[interaction_term, "Pr(>|z|)"]

cat("【乘法交互】\n")
cat("交互项系数:", interaction_coef, "\n")
cat("交互项 HR (exp(coef)):", interaction_hr, "\n")
cat("95% CI:", interaction_lower, "-", interaction_upper, "\n")
cat("p 值:", interaction_p, "\n\n")
```


```{r}
########################################
## 3.1 Additive interaction (RERI) 计算
########################################
# 提取各参数系数
beta_lonely <- summary_lonely_emm$coefficients["lonelinessLonely", "coef"]     # loneliness 主效应
beta_pi     <- summary_lonely_emm$coefficients["vigor_paYes", "coef"] # vigor_pa 主效应
beta_int    <- interaction_coef                                               # 交互项

# 计算各暴露组合的 HR
HR10 <- exp(beta_lonely)                      # loneliness alone (vigor_pa = 0)
HR01 <- exp(beta_pi)                          # vigor_pa alone (loneliness = 0)
HR11 <- exp(beta_lonely + beta_pi + beta_int)  # both exposures

RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
cat("HR (loneliness alone) =", HR10, "\n")
cat("HR (vigor_pa alone) =", HR01, "\n")
cat("HR (both exposures) =", HR11, "\n")
cat("RERI =", RERI, "\n")

##############################################
## 计算 RERI 的标准误、95% CI 和 p 值 (Delta 方法)
##############################################
# 获取交互模型的协方差矩阵，并提取相关参数的子矩阵
V <- vcov(cox_model_lonely_emm)
param_names <- c("lonelinessLonely", "vigor_paYes", interaction_term)
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各系数的偏导数
d_beta <- c(
  exp(beta_lonely + beta_pi + beta_int) - exp(beta_lonely), # ∂RERI/∂β_lonely
  exp(beta_lonely + beta_pi + beta_int) - exp(beta_pi),      # ∂RERI/∂β_pi
  exp(beta_lonely + beta_pi + beta_int)                       # ∂RERI/∂β_int
)

Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\n【RERI 结果】\n")
cat("RERI =", RERI, "\n")
cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")
cat("z =", z_RERI, "\n")
cat("p 值 =", p_RERI, "\n")
```

```{r}
######################################
## 4. 森林图绘制 - Loneliness 系列模型
######################################
tabletext <- cbind(
  c("Model", "Loneliness only", "Adjusted", "Adj + PI", "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr1), " (", sprintf("%.2f", lower1), "-", sprintf("%.2f", upper1), ")"),
    paste0(sprintf("%.2f", hr2), " (", sprintf("%.2f", lower2), "-", sprintf("%.2f", upper2), ")"),
    paste0(sprintf("%.2f", hr3), " (", sprintf("%.2f", lower3), "-", sprintf("%.2f", upper3), ")"),
    paste0(sprintf("%.2f", hr4), " (", sprintf("%.2f", lower4), "-", sprintf("%.2f", upper4), ")")
  ),
  c("p-value",
    ifelse(p1 < 0.001, "<0.001", sprintf("%.3f", p1)),
    ifelse(p2 < 0.001, "<0.001", sprintf("%.3f", p2)),
    ifelse(p3 < 0.001, "<0.001", sprintf("%.3f", p3)),
    ifelse(p4 < 0.001, "<0.001", sprintf("%.3f", p4)))
)

forest_data <- data.frame(
  mean = c(NA, hr1, hr2, hr3, hr4),
  lower = c(NA, lower1, lower2, lower3, lower4),
  upper = c(NA, upper1, upper2, upper3, upper4)
)

forestplot(
  labeltext = tabletext,
  mean = forest_data$mean,
  lower = forest_data$lower,
  upper = forest_data$upper,
  is.summary = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  zero = 1,
  boxsize = 0.2,
  lineheight = "auto",
  col = fpColors(box = "royalblue", line = "darkblue", summary = "royalblue"),
  xlab = "Hazard Ratio (95% CI)",
  hrzl_lines = list("2" = gpar(lty = 2)),
  txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                   ticks = gpar(cex = 0.9),
                   xlab = gpar(cex = 1.2),
                   title = gpar(cex = 1.3)),
  title = "Association between Loneliness and Depression Risk"
)
```

### social isolation
```{r}
###############################
## Social isolation 模型分析 ##
###############################
hrs_data_std$isolation <- relevel(hrs_data_std$isolation, ref = "No")
# 模型1：仅包含 isolation 单变量 Cox 模型
cox_model_iso_raw <- coxph(Surv(time, event) ~ isolation, data = hrs_data_std)

# 模型2：调整协变量的 Cox 模型（不含身体活动）
cox_model_iso_adj <- coxph(Surv(time, event) ~ isolation + age + sex + race + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = hrs_data_std)

# 模型3：调整协变量模型，额外控制 vigor_pa 作为共变量
cox_model_iso_pi <- coxph(Surv(time, event) ~ isolation + vigor_pa + age + sex + race + mar_status + education + employment +
                            bmi + smoking + alcohol + ncd,
                          data = hrs_data_std)

# 模型4：包含 isolation 与 vigor_pa 交互项的 Cox 模型
cox_model_iso_emm <- coxph(Surv(time, event) ~ isolation * vigor_pa + age + sex + race + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = hrs_data_std)
```

```{r}

###################################
## 结果提取及打印
###################################

# 提取模型1结果（假定 isolation 的待检验水平为 "Yes"）
summary_iso_raw <- summary(cox_model_iso_raw)
hr_iso1       <- summary_iso_raw$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "lower .95"]
upper_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "upper .95"]
p_val_iso1    <- summary_iso_raw$coefficients["isolationYes", "Pr(>|z|)"]

# 提取模型2结果
summary_iso_adj <- summary(cox_model_iso_adj)
hr_iso2       <- summary_iso_adj$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "lower .95"]
upper_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "upper .95"]
p_val_iso2    <- summary_iso_adj$coefficients["isolationYes", "Pr(>|z|)"]

# 提取模型3结果
summary_iso_pi <- summary(cox_model_iso_pi)
hr_iso3       <- summary_iso_pi$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "lower .95"]
upper_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "upper .95"]
p_val_iso3    <- summary_iso_pi$coefficients["isolationYes", "Pr(>|z|)"]

# 提取模型4结果 - isolation 主效应
summary_iso_emm <- summary(cox_model_iso_emm)
hr_iso4       <- summary_iso_emm$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "lower .95"]
upper_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "upper .95"]
p_val_iso4    <- summary_iso_emm$coefficients["isolationYes", "Pr(>|z|)"]

# 交互项效果提取（假设交互项名称为 "isolationYes:vigor_paYes"）
interaction_term_iso <- "isolationYes:vigor_paYes"
interaction_coef_iso <- summary_iso_emm$coefficients[interaction_term_iso, "coef"]
interaction_hr_iso   <- summary_iso_emm$conf.int[interaction_term_iso, "exp(coef)"]
interaction_lower_iso<- summary_iso_emm$conf.int[interaction_term_iso, "lower .95"]
interaction_upper_iso<- summary_iso_emm$conf.int[interaction_term_iso, "upper .95"]
interaction_p_iso    <- summary_iso_emm$coefficients[interaction_term_iso, "Pr(>|z|)"]

cat("【乘法交互】\n")
cat("交互项系数:", interaction_coef_iso, "\n")
cat("交互项 HR (exp(coef)):", interaction_hr_iso, "\n")
cat("95% CI:", interaction_lower_iso, "-", interaction_upper_iso, "\n")
cat("p 值:", interaction_p_iso, "\n\n")

```

                    
```{r}
#############################################
## Additive interaction (RERI) 计算
#############################################
# 提取系数：
beta_iso <- summary_iso_emm$coefficients["isolationYes", "coef"]
beta_pi  <- summary_iso_emm$coefficients["vigor_paYes", "coef"]
beta_int <- interaction_coef_iso

# 计算各暴露组合的风险比
HR10 <- exp(beta_iso)                      # isolation alone (vigor_pa = 0)
HR01 <- exp(beta_pi)                       # vigor_pa alone (isolation = 0)
HR11 <- exp(beta_iso + beta_pi + beta_int)   # 同时暴露 (both)

RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
cat("HR (isolation only) =", HR10, "\n")
cat("HR (physical inactivity only) =", HR01, "\n")
cat("HR (both exposures) =", HR11, "\n")
cat("RERI =", RERI, "\n")

#############################################
## 计算 RERI 的95% CI及 p 值 (Delta 方法)
#############################################
# 获取交互模型的协方差矩阵
V <- vcov(cox_model_iso_emm)
param_names <- c("isolationYes", "vigor_paYes", "isolationYes:vigor_paYes")
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各系数的偏导数
d_beta <- c(
  exp(beta_iso + beta_pi + beta_int) - exp(beta_iso), # dRERI/d(beta_iso)
  exp(beta_iso + beta_pi + beta_int) - exp(beta_pi),    # dRERI/d(beta_pi)
  exp(beta_iso + beta_pi + beta_int)                    # dRERI/d(beta_int)
)

Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\n【RERI 的结果】\n")
cat("RERI =", RERI, "\n")
cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")
cat("z =", z_RERI, "\n")
cat("p 值 =", p_RERI, "\n")

```

```{r}
# 先装载所需包
if (!require(forestplot)) install.packages("forestplot")
library(forestplot)
library(grid)

# 1. 准备 labeltext（左侧表格文字）
tabletext_iso <- cbind(
  c("Model",
    "Isolation only",
    "Adjusted",
    "Adj + PI",
    "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr_iso1), " (", sprintf("%.2f", lower_ci_iso1), "-", sprintf("%.2f", upper_ci_iso1), ")"),
    paste0(sprintf("%.2f", hr_iso2), " (", sprintf("%.2f", lower_ci_iso2), "-", sprintf("%.2f", upper_ci_iso2), ")"),
    paste0(sprintf("%.2f", hr_iso3), " (", sprintf("%.2f", lower_ci_iso3), "-", sprintf("%.2f", upper_ci_iso3), ")"),
    paste0(sprintf("%.2f", hr_iso4), " (", sprintf("%.2f", lower_ci_iso4), "-", sprintf("%.2f", upper_ci_iso4), ")")
  ),
  c("p‑value",
    ifelse(p_val_iso1 < 0.001, "<0.001", sprintf("%.3f", p_val_iso1)),
    ifelse(p_val_iso2 < 0.001, "<0.001", sprintf("%.3f", p_val_iso2)),
    ifelse(p_val_iso3 < 0.001, "<0.001", sprintf("%.3f", p_val_iso3)),
    ifelse(p_val_iso4 < 0.001, "<0.001", sprintf("%.3f", p_val_iso4))
  )
)

# 2. 准备数值数据（注意，第一个元素要填 NA 对齐 header 行）
forest_data_iso <- data.frame(
  mean  = c(NA, hr_iso1,   hr_iso2,   hr_iso3,   hr_iso4),
  lower = c(NA, lower_ci_iso1, lower_ci_iso2, lower_ci_iso3, lower_ci_iso4),
  upper = c(NA, upper_ci_iso1, upper_ci_iso2, upper_ci_iso3, upper_ci_iso4)
)

# 3. 绘图
forestplot(
  labeltext   = tabletext_iso,
  mean        = forest_data_iso$mean,
  lower       = forest_data_iso$lower,
  upper       = forest_data_iso$upper,
  is.summary  = c(TRUE, rep(FALSE, 4)),  # 第一行当作表头
  zero        = 1,                      # 虚线在 HR=1 处
  boxsize     = 0.2,
  lineheight  = "auto",
  hrzl_lines  = list("2" = gpar(lty = 2)),  # 在 header 和第一行结果之间画虚线
  xlab        = "Hazard Ratio (95% CI)",
  txt_gp      = fpTxtGp(
                   label = gpar(cex = 1.1),
                   ticks = gpar(cex = 0.9),
                   xlab  = gpar(cex = 1.1),
                   title = gpar(cex = 1.2)
                 ),
  title       = "Social Isolation 与抑郁风险的关联"
)

```




# 2010–2018 for ELSA (waves 5–9)

## Baseline

### Data Import
```{r}

# 读取 wave 4 核心访谈数据baseline

elsa_wave4_core <- read_dta("./data/UKDA-5050-stata/stata/stata13_se/wave_4_elsa_data_v3.dta")

```

```{r}
elsa_baseline = elsa_wave4_core|>
  # Step 1: 筛选年龄 >= 55 且有CES-D测量 且 baseline无抑郁
  filter(
    indager >= 55  # 年龄变量，dvage 是官方变量   
  )|>
  # Step2 CESD:
  mutate(across(
    .cols = c(psceda, pscedg, pscedh, pscedb, pscedc, pscedd, pscedf),
    .fns = ~ na_if(., -9) |> na_if(-8) |> na_if(-2) |> na_if(-1)
  ))|>
  mutate(
    cesd_score = rowSums(cbind(
      psceda == 1,  # 感到抑郁
      pscedg == 1,  # 感到悲伤
      pscedh == 1,  # 难以开始做事
      pscedb == 1,  # 一切都很努力
      pscedc == 1,  # 睡眠不好
      pscedd == 2,  # 不快乐（反向）
      pscedf == 2   # 没有生活乐趣（反向）
    ), na.rm = FALSE),  # ⚠️ 保留 NA,
    depression_event = ifelse(cesd_score >= 2, 1, 0)) |> # Revised CES-D ≥2 = depression)
  # Step2 CESD:Without information about depression at baseline
  filter(!is.na(cesd_score))　|>
  # Step2 CESD:With depression at baseline
  filter(cesd_score < 2)|>
  # Step3: Build loneliness
    #3.1 Build loneliness
      # 3.11. 计算三项 R-UCLA 总分及二值变量（总分≥4判定为孤独）
      mutate(
        loneliness_three = scfeela + scfeelb + scfeelc,
        lonely_three = if_else(loneliness_three >= 4, 1, 0, missing = NA_real_)
      ) %>%
      # 3.12. 处理单项测量 scfeele
      mutate(
        # 仅当 scfeele 为有效回答（1、2、3）时返回1，否则当为负值时视为缺失
        lonely_single = case_when(
          scfeele %in% c(2, 3) ~ 1,
          scfeele == 1 ~ 0, 
          scfeele < 0 ~ NA_real_
        )
      ) %>%
      # 3.13. 综合两种测量结果：只要任一指标为1，则定义为孤独
      mutate(
        loneliness_binary = if_else(lonely_three == 1 | lonely_single == 1, 1, 0, missing = NA_real_)
      ) %>%
      # 3.14. 将 loneliness_binary 转化为因子
      mutate(
        Loneliness = factor(loneliness_binary, levels = c(0, 1), labels = c("Not lonely", "Lonely"))
      )|>
  # Step 4: 建立 Social_isolation 指标
    # 4.1 处理社交参与变量，将无效值(-9, -8, -2, -1)转换为 NA；变量包括：scorg01, scorg03, scorg04, scorg06, scorg07, scorg08
    mutate(across(
      .cols = c(scorg01, scorg03, scorg04, scorg06, scorg07, scorg08),
      .fns = ~ if_else(. %in% c(-9, -8, -2, -1), NA_real_, as.numeric(.))
    )) |>
    # 4.2 汇总上述变量（1表示有参与，0表示没有）得到参与总数
    mutate(
      total_social_yes = rowSums(across(c(scorg01, scorg03, scorg04, scorg06, scorg07, scorg08)), na.rm = TRUE)
    ) |>
    # 4.3 定义社交隔离指标：若 total_social_yes 为 0，则说明没有参与任何社交活动
    mutate(
      social_isolation_binary = if_else(total_social_yes == 0, 1, 0)
    ) |>
    # 4.4 转换为因子：0 = "Socially integrated", 1 = "Yes"
    mutate(
      Social_isolation = factor(social_isolation_binary,
                                levels = c(0, 1),
                                labels = c("No", "Yes"))
    )|>
  # Step 5: 建立 Physical inactivity 指标
    # 5.1 对 heacta 和 heactb 进行无效值处理（将 -9, -8, -2, -1 转为 NA）
    mutate(across(
      .cols = c(heacta, heactb),
      .fns = ~ if_else(. %in% c(-9, -8, -2, -1), NA_real_, as.numeric(.))
    )) |>
    # 5.2 分别对激烈和中等体育活动进行二值转换：
    #     对于 heacta: 1、2 => 活跃 (0); 3、4 => 不活跃 (1)
    #     对于 heactb: 同上
    mutate(
      vigorous_active = case_when(
        heacta %in% c(1, 2) ~ 1,
        heacta %in% c(3, 4) ~ 0,
        TRUE ~ NA_real_
      ),
      moderate_active = case_when(
        heactb %in% c(1, 2) ~ 1,
        heactb %in% c(3, 4) ~ 0,
        TRUE ~ NA_real_
      )
    ) |>
    # 5.3 综合两个指标：只要任一项显示活跃（0），则总体上视为“活跃”（physical inactivity = 0），
    #     仅当两项均为低频（1）时，定义为身体不活跃 (physical inactivity = 1)
    mutate(
      vigor_pa_binary = case_when(
        (!is.na(vigorous_active) & vigorous_active == 1) | (!is.na(moderate_active) & moderate_active == 1) ~ 0,
        (vigorous_active == 0 & moderate_active == 0) ~ 1,
        TRUE ~ NA_real_
      )
    ) |>
    # 5.4 转换为因子变量
    mutate(vigor_pa = factor(vigor_pa_binary, levels = c(0, 1),labels = c("No", "Yes"))
           )|>
  
  # Step 6: 处理 dimar 变量，将无效值转换为 NA（如未提前处理）
    mutate(dimar = if_else(dimar %in% c(-9, -8, -2, -1), NA_real_, dimar)) |>
    # 建立 Marital_status 变量：
    # “Married or partnered”：包括 value = 2, 3, 4, 5, 8, 11，
    # “Single”：包括 value = 1, 6, 7, 9, 10
    mutate(Marital_status = case_when(
      dimar %in% c(2, 3, 4, 5, 8, 11) ~ "Married or partnered",
      dimar %in% c(1, 6, 7, 9, 10) ~ "Single",
      TRUE ~ NA_character_
    )) |>
    # 转换为因子
    mutate(Marital_status = factor(Marital_status, levels = c("Married or partnered", "Single")))|>
  
  # Step 7: 建立 Education 变量
    # 1. 将 -9, -8, -3 视为无效值并转换为 NA
    mutate(w4edqual = if_else(w4edqual %in% c(-9, -8, -3), NA_real_, w4edqual)) |>
    # 2. 基于 w4edqual 的取值分组
    mutate(
      Education = case_when(
        w4edqual %in% c(1)      ~ "Tertiary",                # 高等教育
        w4edqual %in% c(2, 3, 4)      ~ "Upper secondary",         # 高中或同等学历
        w4edqual %in% c(5, 6, 7, -8)   ~ "Less than upper secondary",
        TRUE                       ~ NA_character_              # 处理剩余意外情况
      )
    ) |>
    # 3. 转换为因子，按照从低到高的顺序
    mutate(Education = factor(Education,levels = c("Less than upper secondary", "Upper secondary","Tertiary"))
    ) |>
  
   # Step 8: 建立 Empoyment status 变量 
    # 处理 wpdes 变量：将无效值转换为 NA
    mutate(
      wpdes = if_else(wpdes %in% c(-9, -8, -2, -1), NA_real_, wpdes),
      Employment_status = case_when(
        wpdes %in% c(1, 96) ~ "Retired",          # Retired 或 Semi-retired
        wpdes %in% c(2, 3)  ~ "Working",            # Employed 或 Self-employed
        wpdes %in% c(4, 5, 6) ~ "Not working",       # Unemployed, Permanently sick or disabled, Looking after home or family
        TRUE ~ NA_character_                       # 对于其他值（如 85,86,95）返回 NA
      )
    ) |>
    # 将 Employment_status 转换为因子，因子水平顺序为：Not working, Working, Retired
    mutate(
      Employment_status = factor(Employment_status,
                                 levels = c("Not working", "Working", "Retired"))
    )|>
    # Step 9: 建立 Alcohol consumption 指标
    # 1. 先将 scako 中的无效值转换为 NA
        mutate(
        scako = case_when(
          scako == -9 ~ NA_real_,
          scako == -1 ~ 8,
          TRUE ~ scako
        )
      ) |>
      # 2. 根据 scako 的取值构建二值变量：
      #    方案中将值 7 和 8 归为“不饮酒”（0），1～6 归为“饮酒”（1）
      mutate(
        alcohol_consumption_binary = case_when(
          scako %in% c(7, 8) ~ 0,
          scako >= 1 & scako <= 6 ~ 1,
          TRUE ~ NA_real_
        )
      ) |>
      # 3. 转换为因子变量
      mutate(
        Alcohol_consumption = factor(alcohol_consumption_binary,
                                     levels = c(0, 1),
                                     labels = c("No", "Yes"))
      )|>
    # Step 10: 建立 Smoke 指标
      # 先对 dhesmk 和 dheska 进行无效值处理，仅将 -5 转为 NA，保留 -1
      mutate(
        dhesmk = if_else(dhesmk %in% c(-5), NA_real_, dhesmk),
        dheska = if_else(dheska %in% c(-5), NA_real_, dheska)
      ) |>
      # 将 -1 (Not applicable) 重新编码为 2 (No), 表示“不吸烟”
      mutate(
        dhesmk = if_else(dhesmk == -1, 2, dhesmk),
        dheska = if_else(dheska == -1, 2, dheska)
      ) |>
      # 根据 dhesmk 和 dheska 构建烟草变量
      mutate(
        Smoke = case_when(
          dheska == 1                         ~ "Current smoker",   # 当前吸烟
          dhesmk == 1 & dheska == 2             ~ "Past smoker",      # 曾经吸烟，但目前已停止
          dhesmk == 2                         ~ "Non-smoker",       # 从未吸烟（或不适用，即认为不吸烟）
          TRUE                                ~ NA_character_       # 其他情况返回 NA
        )
      ) |>
      # 转换为因子，设置水平顺序：Non-smoker, Past smoker, Current smoker
      mutate(
        Smoke = factor(Smoke, levels = c("Non-smoker", "Past smoker", "Current smoker"))
      )|>
      # Step 11: 建立 NCDs 指标
      # 1. 对所有 NCD 相关变量进行重新编码：
      #    如果原始值 == 1，则编码为 1（有该病）；
      #    如果原始值 == 2 或属于 c(-9, -8, -1, 3)，则编码为 0（没有该病）；
      #    如果值为 -2，则保留 NA（作为无效回答）。
      mutate(across(
        c(hedacbp, hedacan, hedacmi, hedachf, hedachm, hedacar,
          hedacst, hedacdi, hedbdlu, hedbdca, hedbdar),
        ~ case_when(
             . == 1 ~ 1,
             . == 2 ~ 0,
             . %in% c(-9, -8, -1, 3) ~ 0,
             . == -2 ~ NA_real_,
             TRUE ~ NA_real_
           )
      )) |>
      # 2. 对每一行求和：ncd_sum 表示受访者有多少种疾病
      mutate(
        ncd_sum = rowSums(across(
          c(hedacbp, hedacan, hedacmi, hedachf, hedachm, hedacar,
            hedacst, hedacdi, hedbdlu, hedbdca, hedbdar),
          ~ .
        ), na.rm = TRUE),
        # 计算每行有效（非缺失）指标的个数
        ncd_non_missing = rowSums(across(
          c(hedacbp, hedacan, hedacmi, hedachf, hedachm, hedacar,
            hedacst, hedacdi, hedbdlu, hedbdca, hedbdar),
          ~ !is.na(.)
        ))
      ) |>
      # 3. 如果某行全部指标均缺失，则 ncd_count 设为 NA；否则 ncd_count 用 ncd_sum 表示总数
      mutate(
        ncd_count = if_else(ncd_non_missing == 0, NA_real_, ncd_sum),
        # 根据 ncd_count 构建 NCDs 指标：至少有1项疾病归为 "One or more"，否则 "None"
        NCDs = if_else(ncd_count >= 1, "One or more", "None")) |>
      # 4. 转换为因子，设定水平为 "None" 和 "One or more"
      mutate(
        NCDs = factor(NCDs, levels = c("None", "One or more"))
      )|>
  # Step 12: 建立 NCDs 指标
      mutate(
          # 将无效值（例如 -9, -8, -1）转换为 NA
          fqethnr = if_else(fqethnr %in% c(-9, -8, -1), NA_real_, fqethnr),
          # 根据 fqethnr 构建 race 变量
          race = case_when(
            fqethnr == 1 ~ "White",
            fqethnr == 2 ~ "Non-White",  # 如果只根据此变量，非白人只能归为 Other
            TRUE ~ NA_character_
          )
        )
  dim(elsa_baseline)
  
```




Loneliness was measured by the original surveys using the 
1. three-term revised University of California, Los Angeles Loneliness Scale (R-UCLA): **scfeela**, **scfeelb**,**scfeelc**, 
  1.1 Total scores range from 3 to 9 (three-item R-UCLA)
  1.2 4 or higher as a cutoff
2. a single question that asked how often respondents felt lonely in the past week or if they felt lonely the majority of time. **scfeele**
  2.1 Total scores range from 0 to 3 , 
  2.2 1 or higher as a cutoff 

Social isolation
Are you a member of any of these organisations`orgno`, clubs or societies 
(Political party; `scorg01`
Church or other religious groups; `scorg03`
Charitable associations; `scorg04`
Social clubs; `scorg06`
Sports clubs, `scorg07`
Any other organisations,clubs or societies; `scorg08`
None)? [the number of choices selected]:
	Value = -9.0	Label = Not answered
	Value = -8.0	Label = Don't know (98)
	Value = -2.0	Label = Schedule Not Applicable
	Value = -1.0	Label = Item not applicable
	Value = 0.0	Label = No
	Value = 1.0	Label = Yes

Physical incactivity:
No = Frequency of taking part in vigorous/moderate physical activity: 1. More than once a week; 2. Once a week
Yes = Frequency of taking part in vigorous/moderate physical activity: 1. One to three times a month; 2. Hardly ever or never.

Frequency does vigorous sports or activities: `heacta`
Frequency does moderate sports or activities:`heactb`
  Value label information for heacta
  	Value = -9.0	Label = Refusal
  	Value = -8.0	Label = Don't Know
  	Value = -2.0	Label = Schedule not applicable
  	Value = -1.0	Label = Item not applicable
  	Value = 1.0	Label = ...more than once a week,
  	Value = 2.0	Label = once a week,
  	Value = 3.0	Label = one to three times a month,
  	Value = 4.0	Label = hardly ever, or never?


NCDs 
1. None:  Participants do not have any communicable diseases. 
2. One or more: Participants have at least one communicable disease: 
        hypertension, `hedacbp`
        heart problems: `hedacan`,`hedacmi`, ` hedachf`, `hedachm`, `hedacar`, 
        stroke, `hedacst`
        diabetes, `hedacdi`
        lung diseases, `hedbdlu`
        cancer, `hedbdca`
        arthritis:`hedbdar`
    This variable is  numeric, the SPSS measurement level is NOMINAL
    	Value label information for hedacst
    	Value = -9.0	Label = Refusal
    	Value = -8.0	Label = Don't Know
    	Value = -2.0	Label = Capi/Interview Error
    	Value = -1.0	Label = Item not applicable
    	Value = 1.0	Label = Yes
    	Value = 2.0	Label = No
    	Value = 3.0	Label = Not read out as didn t make sense



```{r}
elsa_wave4_bmi <- read_dta("./data/UKDA-5050-stata/stata/stata13_se/wave_4_nurse_data.dta") %>%
  select(idauniq, bmival)

# 合并 baseline 数据和 BMI 数据，并进行 BMI 插补和分类
elsa_baseline_bmi <- elsa_baseline %>%
  left_join(elsa_wave4_bmi, by = "idauniq") %>%
  mutate(bmival_imputed = if_else(is.na(bmival),
                                  median(bmival, na.rm = TRUE),
                                  bmival)) %>%
  mutate(
    BMI = case_when(
      bmival_imputed < 25 ~ "Underweight or healthy weight",
      bmival_imputed >= 25 & bmival_imputed < 30 ~ "Overweight",
      bmival_imputed >= 30 ~ "Obesity",
      TRUE ~ NA_character_
    ),
    BMI = factor(BMI, levels = c("Underweight or healthy weight", "Overweight", "Obesity"))
  )

# 查看各变量缺失数量
elsa_baseline_bmi %>% 
  summarise(
    miss_age = sum(is.na(indager)),
    miss_Social_isolation = sum(is.na(Social_isolation)),
    miss_Loneliness = sum(is.na(Loneliness)),
    miss_vigor_pa = sum(is.na(vigor_pa)),
    miss_indsex = sum(is.na(indsex)),
    miss_Marital_status = sum(is.na(Marital_status)),
    miss_Education = sum(is.na(Education)),
    miss_Employment_status = sum(is.na(Employment_status)),
    miss_BMI = sum(is.na(BMI)),
    miss_Alcohol_consumption = sum(is.na(Alcohol_consumption)),
    miss_Smoke = sum(is.na(Smoke)),
    miss_NCDs = sum(is.na(NCDs)),
    miss_race = sum(is.na(race))
  )

```



```{r}
elsa_baseline_non_na = elsa_baseline_bmi |>
   
# Step: With missing data in baseline characteristics:
    filter(
      !is.na(Social_isolation),  #Social activities: Respondent is NOT a member of any organisations, clubs or societies
      !is.na(Loneliness), #  felt loneliness
      !is.na(vigor_pa), # PA
      !is.na(indsex),# sex
      !is.na(Marital_status),# marital status
      !is.na(Education),# Education
      !is.na(Employment_status), # Employment status
      !is.na(BMI), # Nurse data里
      !is.na(Alcohol_consumption),# Alcohol consumption
      !is.na(Smoke),# smoking
      !is.na(NCDs),
      !is.na(race)
      )
dim(elsa_baseline_non_na)

```


	
## Follow-up:
### import
```{r}
# 文件列表：请根据实际文件路径修改
wave_files <- list(
  wave5 = "./data/UKDA-5050-stata/stata/stata13_se/wave_5_elsa_data_v4.dta",
  wave6 = "./data/UKDA-5050-stata/stata/stata13_se/wave_6_elsa_data_v2.dta",
  wave7 = "./data/UKDA-5050-stata/stata/stata13_se/wave_7_elsa_data.dta",
  wave8 = "./data/UKDA-5050-stata/stata/stata13_se/wave_8_elsa_data_eul_v2.dta",
  wave9 = "./data/UKDA-5050-stata/stata/stata13_se/wave_9_elsa_data_eul_v2.dta"
)

# 定义一个函数用于读取每个波数据
# 此函数中只提取（或转换）计算 CES-D 相关的变量以及 idauniq
# 并统一将这些变量重命名为标准名称： psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh
read_wave_data <- function(file, wave_label) {
  df <- read_dta(file)
  
  # 提取主键和CES-D相关变量（根据你实际的数据修改变量名）
  # 这里假设：
  #   - 对于 wave5，该波已经使用标准名称：psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh
  #   - 对于 wave6，假设原有变量名分别为 cesda, cesdb, cesdc, cesdd, cesde, cesdf, cesdg, cesdh
  #     （请根据实际情况修改）
  wave_num <- as.numeric(gsub("wave", "", wave_label))
  df <- df %>%
    mutate(
      wave = wave_num,
      followup_time = case_when(
        wave == 5 ~ 2,
        wave == 6 ~ 4,
        wave == 7 ~ 6,
        wave == 8 ~ 8,
        wave == 9 ~ 10,
        TRUE ~ NA_real_
      )
    )
  
  # 根据波次对CES-D变量进行重命名和提取，仅保留你需要的变量
  if(wave_num == 5) {
    # wave5：假设已经是标准变量名
    df <- df %>% select(idauniq, psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh, wave, followup_time)
  } else if(wave_num == 6) {
    # wave6：示例重命名，请将右边的变量名替换为该波实际的名称
    df <- df %>%
      rename(
        psceda = PScedA,   # 示例：将 cesda 重命名为 psceda
        pscedb = PScedB,
        pscedc = PScedC,
        pscedd = PScedD,
        pscedf = PScedF,   # 假设用于反向的题项
        pscedg = PScedG,
        pscedh = PScedH
      ) %>%
      select(idauniq, psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh, wave, followup_time)
  } else if(wave_num == 7) {
    # wave7：请根据实际变量名重命名
    df <- df %>%
      rename(
        psceda = PScedA,   # 示例：将 cesda 重命名为 psceda
        pscedb = PScedB,
        pscedc = PScedC,
        pscedd = PScedD,
        pscedf = PScedF,   # 假设用于反向的题项
        pscedg = PScedG,
        pscedh = PScedH
      ) %>%
      select(idauniq, psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh, wave, followup_time)
  } else if(wave_num == 8) {
    # wave8：同样的重命名过程
    df <- df %>%
      rename(
        psceda = psceda,  # 示例变量名称
        pscedb = pscedb,
        pscedc = pscedc,
        pscedd = pscedd,
        pscedf = pscedf,
        pscedg = pscedg,
        pscedh = pscedh
      ) %>%
      select(idauniq, psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh, wave, followup_time)
  } else if(wave_num == 9) {
    # wave9：同样
    df <- df %>%
      rename(
        psceda = psceda,  # 示例变量名称
        pscedb = pscedb,
        pscedc = pscedc,
        pscedd = pscedd,
        pscedf = pscedf,
        pscedg = pscedg,
        pscedh = pscedh
      ) %>%
      select(idauniq, psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh, wave, followup_time)
  }
  
  return(df)
}

# 合并所有波次数据为长格式随访数据集
elsa_long_followup <- imap_dfr(wave_files, ~ read_wave_data(.x, .y))
glimpse(elsa_long_followup)

# 以下对长格式数据进行 CES-D 计算
# 这里统一对所有波次中用于计算 CES-D 的变量做无效值处理，并计算总分及事件状态
elsa_long_followup <- elsa_long_followup %>%
  mutate(across(
      .cols = c(psceda, pscedb, pscedc, pscedd, pscedf, pscedg, pscedh),
      .fns = ~ na_if(., -9) |> na_if(-8) |> na_if(-2) |> na_if(-1)
  ))|>
  mutate(
    cesd_score = rowSums(cbind(
      psceda == 1,  # 感到抑郁
      pscedb == 1,  # 感到悲伤
      pscedc == 1,  # 难以开始做事
      pscedd == 2,  # 一切都很努力
      pscedf == 2,  # 不快乐（反向）
      pscedg == 1,  # 某题示例
      pscedh == 1   # 某题示例
    ), na.rm = FALSE),
    depression_event = if_else(cesd_score >= 2, 1, 0)
  )



```



```{r}

first_event_time <- function(x) {
  nonmiss <- x[!is.na(x)]
  if(length(nonmiss) == 0) return(NA_real_) else return(min(nonmiss))
}

# 构建随访摘要
followup_summary <- elsa_long_followup %>%
  group_by(idauniq) %>%
  arrange(followup_time) %>%
  summarise(
    non_missing_cesd = sum(!is.na(cesd_score)),
    any_event = any(depression_event == 1, na.rm = TRUE),
    event_time = if_else(any_event,
                         first_event_time(followup_time[depression_event == 1]),
                         # 如果没有事件，则取该组中最大（最后一次访谈）的随访时间
                         if_else(sum(!is.na(followup_time)) > 0,
                                 max(followup_time, na.rm = TRUE),
                                 NA_real_)),
    depression_event = if_else(any_event, 1, 0),
    .groups = "drop"
  ) %>%
  # 排除访谈次数不足的受访者（例如至少有2次有效测量）
  filter(non_missing_cesd >= 2)

```

```{r}
### 3. 合并基线数据并输出最终数据集

elsa_cox_data <- elsa_baseline_non_na |>
  select(idauniq, indager, indsex, Marital_status, Education, Employment_status, BMI, 
         Alcohol_consumption, Smoke, NCDs, race, Social_isolation, Loneliness, vigor_pa)|>
  left_join(followup_summary, by = "idauniq")|>
  drop_na(event_time,depression_event )|>
  select(-any_event, -non_missing_cesd)
dim(elsa_cox_data)
write_csv(elsa_cox_data, "./data/cleaned/ELSA_4_9_cox.csv")
```

## DATA analysis

```{r}
# rename variables to use model code

elsa_data_std <- elsa_cox_data |>
  rename(
    id = idauniq,
    age = indager,
    sex = indsex,
    mar_status = Marital_status,
    education = Education,
    employment = Employment_status,
    bmi = BMI,
    smoking = Smoke,
    alcohol = Alcohol_consumption,
    ncd = NCDs,
    isolation = Social_isolation,
    loneliness = Loneliness,
    vigor_pa = vigor_pa,
    event = depression_event,
    time = event_time
  ) %>%
  mutate(data_source = "ELSA")

# 检查新的变量名称
print(names(elsa_data_std))
table(elsa_data_std$data_source)

# 可选：输出重命名后的数据集，后续分析将基于该标准数据
write_csv(elsa_data_std, "./data/cleaned/ELSA_4_9_cox_renamed.csv")
```
###  EDA
```{r}
dataset_std = elsa_data_std
# 定义要包含在表中的变量
vars <- c("age", "sex", "race", "mar_status", "education", "employment", 
          "bmi", "smoking", "alcohol" ,"ncd","race" ,"isolation", "loneliness")

# 定义哪些变量为分类变量
categorical_vars <- c("isolation", "loneliness", "sex", "race", "mar_status", "education", "employment", 
                      "smoking", "alcohol", "ncd", "bmi")

# 创建 Table 1，假设 vigor_pa（这里统一为 inactivity）是分层变量
table1_generic <- CreateTableOne(
  vars = vars,
  strata = "vigor_pa",
  data = dataset_std,
  factorVars = categorical_vars
)
print(table1_generic)
# 提取为 data.frame
table_df <- print(table1_generic, quote = FALSE, noSpaces = TRUE, printToggle = FALSE)

# 然后写入 CSV
write_csv(as.data.frame(table_df), "./data/cleaned/ELSA_3_5_table1_generic.csv")

```


```{r}
# 图2：按 Physical inactivity 分组的各分类变量分布

dataset_std %>%
  select(vigor_pa, categorical_vars) %>%
  mutate(across(everything(), ~ as.character(.)))|>
  pivot_longer(cols = -vigor_pa, names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = factor(Value), fill = factor(vigor_pa))) +
  geom_bar(position = "dodge") +
  facet_wrap(~ Variable, scales = "free_x") +
  labs(
    title = "Distribution of Categorical Variables by Physical Activity Group",
    subtitle = paste("Data Source:", unique(dataset_std$data_source)),
    x = "Category", 
    y = "Count",
    fill = "Physical Inactivity"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))


```


# Cox Model——ELSA

## Loneliness

### FIt Cox 模型
```{r}
# 4. Cox 模型部分
# 模型1：仅包含 loneliness 单变量 Cox 模型
cox_model_lonely_raw <- coxph(Surv(time, event) ~ loneliness, data = dataset_std)

# 模型2：调整人口统计和健康相关协变量的 Cox 模型
cox_model_lonely_adj <- coxph(Surv(time, event) ~ loneliness + 
                                age + sex + race + mar_status + education + employment +
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)

# 模型3：调整vigor_pa、人口统计和健康相关协变量的 Cox 模型
cox_model_lonely_emm <- coxph(Surv(time, event) ~ loneliness + vigor_pa + 
                                age + sex + race + mar_status + education + employment+
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)


# 模型4：包含 loneliness 与 vigor_pa 交互项的 Cox 模型
cox_model_lonely_emm <- coxph(Surv(time, event) ~ loneliness * vigor_pa + 
                                age + sex + race + mar_status + education + employment+
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)


```


### 提取模型结果用于森林图
```{r}
# 模型1结果
summary_lonely_raw <- summary(cox_model_lonely_raw)
hr1 <- summary_lonely_raw$conf.int["lonelinessLonely", "exp(coef)"]
lower1 <- summary_lonely_raw$conf.int["lonelinessLonely", "lower .95"]
upper1 <- summary_lonely_raw$conf.int["lonelinessLonely", "upper .95"]
p1 <- summary_lonely_raw$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型2结果
summary_lonely_adj <- summary(cox_model_lonely_adj)
hr2 <- summary_lonely_adj$conf.int["lonelinessLonely", "exp(coef)"]
lower2 <- summary_lonely_adj$conf.int["lonelinessLonely", "lower .95"]
upper2 <- summary_lonely_adj$conf.int["lonelinessLonely", "upper .95"]
p2 <- summary_lonely_adj$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型3结果
summary_lonely_pi <- summary(cox_model_lonely_pi)
hr3 <- summary_lonely_pi$conf.int["lonelinessLonely", "exp(coef)"]
lower3 <- summary_lonely_pi$conf.int["lonelinessLonely", "lower .95"]
upper3 <- summary_lonely_pi$conf.int["lonelinessLonely", "upper .95"]
p3 <- summary_lonely_pi$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型4结果 - loneliness 主效应
summary_lonely_emm <- summary(cox_model_lonely_emm)
hr4 <- summary_lonely_emm$conf.int["lonelinessLonely", "exp(coef)"]
lower4 <- summary_lonely_emm$conf.int["lonelinessLonely", "lower .95"]
upper4 <- summary_lonely_emm$conf.int["lonelinessLonely", "upper .95"]
p4 <- summary_lonely_emm$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 提取交互项效果（假设交互项名称为 "lonelinessLonely:vigor_paLow activity"，
# 表示当 vigor_pa 为 "Low activity" 时，loneliness 效应的额外修正）
interaction_term <- "lonelinessLonely:vigor_paYes"
interaction_coef <- summary_lonely_emm$coefficients[interaction_term, "coef"]
interaction_hr   <- summary_lonely_emm$conf.int[interaction_term, "exp(coef)"]
interaction_lower <- summary_lonely_emm$conf.int[interaction_term, "lower .95"]
interaction_upper <- summary_lonely_emm$conf.int[interaction_term, "upper .95"]
interaction_p     <- summary_lonely_emm$coefficients[interaction_term, "Pr(>|z|)"]

cat("交互项 (Loneliness:vigor_pa) 效应:\n")
cat("系数:", interaction_coef, "\n")
cat("风险比 (HR):", interaction_hr, "\n")
cat("95% CI:", interaction_lower, "-", interaction_upper, "\n")
cat("p值:", interaction_p, "\n\n")


```
```{r}
###################################
## Multiplicative interaction
###################################
cat("【乘法交互】\n")
cat("交互项风险比 (exp(beta_interaction)) =", interaction_hr, "\n")
cat("95% CI: (", interaction_lower, ",", interaction_upper, ")\n")
cat("p 值:", interaction_p, "\n\n")

```

```{r}
###################################
## Additive interaction (RERI) 计算
###################################
# 提取相关系数（确保名称与模型输出一致）
beta_iso <- summary_lonely_emm$coefficients["lonelinessLonely", "coef"]       # loneliness 主效应
beta_pi  <- summary_lonely_emm$coefficients["vigor_paYes", "coef"]  # vigor_pa 主效应
beta_int <- interaction_coef                                                  # 交互项

# 计算各暴露组合下的风险比
HR10 <- exp(beta_iso)                            # loneliness alone (X=1, Z=0)
HR01 <- exp(beta_pi)                             # vigor_pa alone (X=0, Z=1)
HR11 <- exp(beta_iso + beta_pi + beta_int)         # 双重暴露 (X=1, Z=1)

RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
cat("HR (loneliness only) =", HR10, "\n")
cat("HR (physical inactivity only) =", HR01, "\n")
cat("HR (both exposures) =", HR11, "\n")
cat("RERI =", RERI, "\n")

###################################
## 计算 RERI 的95% CI及 p 值（delta 方法）
###################################
# 获取模型协方差矩阵
V <- vcov(cox_model_lonely_emm)
# 按顺序提取相关参数协方差子矩阵（假定参数顺序为 loneliness, vigor_pa, 交互项）
param_names <- c("lonelinessLonely", "vigor_paYes", interaction_term)
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各参数的偏导数
d_beta <- c(
  exp(beta_iso + beta_pi + beta_int) - exp(beta_iso),  # dRERI/d(beta_iso)
  exp(beta_iso + beta_pi + beta_int) - exp(beta_pi),     # dRERI/d(beta_pi)
  exp(beta_iso + beta_pi + beta_int)                     # dRERI/d(beta_int)
)

Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\nRERI 的结果：\n")
cat("RERI =", RERI, "\n")
cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")
cat("z =", z_RERI, "\n")
cat("p 值 =", p_RERI, "\n")

```






```{r}
# 准备表格文本
tabletext <- cbind(
  c("Model", "Loneliness only", "Adjusted", "Adj + Physical inactivity", "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr1), " (", sprintf("%.2f", lower1), "-", sprintf("%.2f", upper1), ")"),
    paste0(sprintf("%.2f", hr2), " (", sprintf("%.2f", lower2), "-", sprintf("%.2f", upper2), ")"),
    paste0(sprintf("%.2f", hr3), " (", sprintf("%.2f", lower3), "-", sprintf("%.2f", upper3), ")"),
    paste0(sprintf("%.2f", hr4), " (", sprintf("%.2f", lower4), "-", sprintf("%.2f", upper4), ")")
  ),
  c("p-value",
    ifelse(p1 < 0.001, "<0.001", sprintf("%.3f", p1)),
    ifelse(p2 < 0.001, "<0.001", sprintf("%.3f", p2)),
    ifelse(p3 < 0.001, "<0.001", sprintf("%.3f", p3)),
    ifelse(p4 < 0.001, "<0.001", sprintf("%.3f", p4))
  )
)

forest_data <- data.frame(
  mean = c(NA, hr1, hr2, hr3, hr4),
  lower = c(NA, lower1, lower2, lower3, lower4),
  upper = c(NA, upper1, upper2, upper3, upper4)
)

forestplot(
  labeltext = tabletext,
  mean = forest_data$mean,
  lower = forest_data$lower,
  upper = forest_data$upper,
  is.summary = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  zero = 1,
  boxsize = 0.2,
  lineheight = "auto",
  col = fpColors(box = "royalblue", line = "darkblue", summary = "royalblue"),
  xlab = "Hazard Ratio (95% CI)",
  hrzl_lines = list("2" = gpar(lty = 2)),
  txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                   ticks = gpar(cex = 0.9),
                   xlab = gpar(cex = 1.2),
                   title = gpar(cex = 1.3)),
  title = "Association between Loneliness and Depression Risk"
)



```
###进行似然比检验 (LRT)比较
```{r}
lrt_result <- anova(cox_model_lonely_adj, cox_model_lonely_emm, test = "LRT")
print(lrt_result)
```



## SSI
```{r}

###############################
##  Social isolation 模型分析  ##
###############################

# 模型1：仅包含 isolation 单变量 Cox 模型
cox_model_iso_raw <- coxph(Surv(time, event) ~ isolation, data = dataset_std)


# 模型2：调整协变量的 Cox 模型（不含身体活动）
cox_model_iso_adj <- coxph(Surv(time, event) ~ isolation + age + sex + race + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = dataset_std)

# 模型3：在模型中加入 vigor_pa 作为协变量（调整模型中额外控制身体活动）
cox_model_iso_pi <- coxph(Surv(time, event) ~ isolation + vigor_pa + age + sex + race + mar_status + education + employment +
                            bmi + smoking + alcohol + ncd,
                          data = dataset_std)

# 模型4：包含 isolation 与 vigor_pa 交互项的 Cox 模型
cox_model_iso_emm <- coxph(Surv(time, event) ~ isolation * vigor_pa + age + sex + race + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = dataset_std)
```



### 结果提取及森林图绘制

```{r}
# 提取模型1结果
summary_iso_raw <- summary(cox_model_iso_raw)
hr_iso1 <- summary_iso_raw$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "lower .95"]
upper_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "upper .95"]
p_val_iso1 <- summary_iso_raw$coefficients["isolationYes", "Pr(>|z|)"]

# 模型2结果
summary_iso_adj <- summary(cox_model_iso_adj)
hr_iso2 <- summary_iso_adj$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "lower .95"]
upper_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "upper .95"]
p_val_iso2 <- summary_iso_adj$coefficients["isolationYes", "Pr(>|z|)"]

# 模型3结果
summary_iso_pi <- summary(cox_model_iso_pi)
hr_iso3 <- summary_iso_pi$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "lower .95"]
upper_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "upper .95"]
p_val_iso3 <- summary_iso_pi$coefficients["isolationYes", "Pr(>|z|)"]

# 模型4结果 - isolation 主效应
summary_iso_emm <- summary(cox_model_iso_emm)
hr_iso4 <- summary_iso_emm$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "lower .95"]
upper_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "upper .95"]
p_val_iso4 <- summary_iso_emm$coefficients["isolationYes", "Pr(>|z|)"]

# 交互项效果提取（假设交互项名称为 "isolationYes:vigor_paLow activity"，
# 表示当 vigor_pa 为 "Low activity" 时，isolation 的额外修正）
interaction_term_iso <- "isolationYes:vigor_paYes"
interaction_coef_iso <- summary_iso_emm$coefficients[interaction_term_iso, "coef"]
interaction_hr_iso   <- summary_iso_emm$conf.int[interaction_term_iso, "exp(coef)"]
interaction_lower_iso <- summary_iso_emm$conf.int[interaction_term_iso, "lower .95"]
interaction_upper_iso <- summary_iso_emm$conf.int[interaction_term_iso, "upper .95"]
interaction_p_iso     <- summary_iso_emm$coefficients[interaction_term_iso, "Pr(>|z|)"]

cat("交互项 (Isolation:vigor_pa) 效应:\n")
cat("系数:", interaction_coef_iso, "\n")
cat("风险比 (HR):", interaction_hr_iso, "\n")
cat("95% CI:", interaction_lower_iso, "-", interaction_upper_iso, "\n")
cat("p值:", interaction_p_iso, "\n")

```

```{r}
######################################
## Multiplicative interaction
######################################
cat("【乘法交互】\n")
cat("交互项风险比 (exp(beta_interaction)) =", interaction_hr_iso, "\n")
cat("95% CI: (", interaction_lower_iso, ",", interaction_upper_iso, ")\n")
cat("p 值:", interaction_p_iso, "\n\n")
```


```{r}
######################################
## Additive interaction (RERI) 计算
######################################
# 提取模型4中各相关系数（请确保名称与模型输出一致）
beta_iso <- summary_iso_emm$coefficients["isolationYes", "coef"]      # isolation 主效应
beta_pi  <- summary_iso_emm$coefficients["vigor_paYes", "coef"]             # vigor_pa 主效应
beta_int <- interaction_coef_iso                                                    # 交互项

# 计算各种暴露组合下的风险比
HR10 <- exp(beta_iso)                       # isolation alone (when vigor_pa = 0)
HR01 <- exp(beta_pi)                        # vigor_pa alone (when isolation = 0)
HR11 <- exp(beta_iso + beta_pi + beta_int)    # both exposures (isolation and vigor_pa)

# RERI 计算公式
RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
cat("HR (isolation only) =", HR10, "\n")
cat("HR (physical inactivity only) =", HR01, "\n")
cat("HR (both exposures) =", HR11, "\n")
cat("RERI =", RERI, "\n")

######################################
## 计算 RERI 的95% CI和 p 值（delta方法）
######################################
# 获取交互模型中相关系数的协方差矩阵
V <- vcov(cox_model_iso_emm)
# 提取相关参数的协方差子矩阵，按顺序为 isolation, vigor_pa, 交互项
param_names <- c("isolationYes", "vigor_paYes", interaction_term_iso)
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各个参数的偏导数
# dRERI/dβ_iso = exp(β_iso + β_pi + β_int) - exp(β_iso)
# dRERI/dβ_pi  = exp(β_iso + β_pi + β_int) - exp(β_pi)
# dRERI/dβ_int = exp(β_iso + β_pi + β_int)
d_beta <- c(
  exp(beta_iso + beta_pi + beta_int) - exp(beta_iso),
  exp(beta_iso + beta_pi + beta_int) - exp(beta_pi),
  exp(beta_iso + beta_pi + beta_int)
)

# 计算 RERI 的方差：Var(RERI) = d_beta' * V_sub * d_beta
Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

# 计算95% CI
RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

# 计算针对 RERI 的 z 统计量和 p 值
z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\nRERI 的结果：\n")
cat("RERI =", RERI, "\n")
cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")
cat("z =", z_RERI, "\n")
cat("p 值 =", p_RERI, "\n")
```

```{r}
##################################
## 森林图绘制 - Social Isolation 系列
##################################
tabletext_iso <- cbind(
  c("Model", "Isolation only", "Adjusted", "Adj + PI", "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr_iso1), " (", sprintf("%.2f", lower_ci_iso1), "-", sprintf("%.2f", upper_ci_iso1), ")"),
    paste0(sprintf("%.2f", hr_iso2), " (", sprintf("%.2f", lower_ci_iso2), "-", sprintf("%.2f", upper_ci_iso2), ")"),
    paste0(sprintf("%.2f", hr_iso3), " (", sprintf("%.2f", lower_ci_iso3), "-", sprintf("%.2f", upper_ci_iso3), ")"),
    paste0(sprintf("%.2f", hr_iso4), " (", sprintf("%.2f", lower_ci_iso4), "-", sprintf("%.2f", upper_ci_iso4), ")")
  ),
  c("p-value",
    ifelse(p_val_iso1 < 0.001, "<0.001", sprintf("%.3f", p_val_iso1)),
    ifelse(p_val_iso2 < 0.001, "<0.001", sprintf("%.3f", p_val_iso2)),
    ifelse(p_val_iso3 < 0.001, "<0.001", sprintf("%.3f", p_val_iso3)),
    ifelse(p_val_iso4 < 0.001, "<0.001", sprintf("%.3f", p_val_iso4))
  )
)

forest_data_iso <- data.frame(
  mean = c(NA, hr_iso1, hr_iso2, hr_iso3, hr_iso4),
  lower = c(NA, lower_ci_iso1, lower_ci_iso2, lower_ci_iso3, lower_ci_iso4),
  upper = c(NA, upper_ci_iso1, upper_ci_iso2, upper_ci_iso3, upper_ci_iso4)
)

forestplot(
  labeltext = tabletext_iso,
  mean = forest_data_iso$mean,
  lower = forest_data_iso$lower,
  upper = forest_data_iso$upper,
  is.summary = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  zero = 1,
  boxsize = 0.2,
  lineheight = "auto",
  col = fpColors(box = "royalblue", line = "darkblue", summary = "royalblue"),
  xlab = "Hazard Ratio (95% CI)",
  hrzl_lines = list("2" = gpar(lty = 2)),
  txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                   ticks = gpar(cex = 0.9),
                   xlab = gpar(cex = 1.2),
                   title = gpar(cex = 1.3)),
  title = "Association between Social Isolation and Depression Risk"
)
```

```{r}
######################################
## LRT 检验 - 比较模型2 与模型4 (Social Isolation)
######################################
lrt_result_iso <- anova(cox_model_iso_adj, cox_model_iso_emm, test = "LRT")
print(lrt_result_iso)
```


```{r}
#################################
## 亚组分析：根据 vigor_pa 分组 ##
#################################
# 身体活跃组（vigor_pa 为 "No"）
active_group <- dataset_std %>% filter(vigor_pa == "No")
cox_active_iso <- coxph(Surv(time, event) ~ isolation + age + sex + race + mar_status + education + employment +
                          bmi + smoking + alcohol + ncd,
                        data = active_group)
# 身体不活跃组（vigor_pa 为 "Yes"）
inactive_group <- dataset_std %>% filter(vigor_pa == "Yes")
cox_inactive_iso <- coxph(Surv(time, event) ~ isolation + age + sex + race + mar_status + education + employment +
                            bmi + smoking + alcohol + ncd,
                          data = inactive_group)

cat("\n身体活跃组中 Isolation 的效应:\n")
print(summary(cox_active_iso)$conf.int["isolationYes", c("exp(coef)", "lower .95", "upper .95")])
cat("p值:", summary(cox_active_iso)$coefficients["isolationYes", "Pr(>|z|)"], "\n")

cat("\n身体不活跃组中 Isolation 的效应:\n")
print(summary(cox_inactive_iso)$conf.int["isolationYes", c("exp(coef)", "lower .95", "upper .95")])
cat("p值:", summary(cox_inactive_iso)$coefficients["isolationYes", "Pr(>|z|)"], "\n")


```



# 2012–2018 for MHAS (waves 3–5)
2012, 2015, 2018
## Load data

```{r}
mhas <- read_dta("./data/H_MHAS_c2.dta")
```


## Selecte Baseline data 

```{r}
mhas_baseline <- mhas |>
                # Step 1: 筛选年龄 ≥ 55
                mutate(
                        estimated_age_at_R3 = case_when(
                          !is.na(r3agey) ~ r3agey,
                          !is.na(r4agey) ~ r4agey - 3,
                          !is.na(r5agey) ~ r5agey - 6,
                          TRUE           ~ NA_real_
                        )
                      ) |>
                filter(estimated_age_at_R3 >= 55) |>
                # Step 2: 清洗 CES-D-7 项目
                mutate(across(
                        c(r3depres, r3effort, r3sleepr, r3whappy, r3enlife, r3fsad, r3ftired),
                        ~ na_if(., -9) |> na_if(-8) |> na_if(-2) |> na_if(-1)
                      )) |>
                # 计算 CES-D 得分（保留 NA）
                mutate(
                        cesd_score = rowSums(cbind(
                          r3depres == 1,
                          r3effort == 1,
                          r3sleepr == 1,
                          r3whappy == 1,
                          r3enlife == 1,
                          r3fsad == 1,
                          r3ftired == 1
                        ), na.rm = FALSE)
                      ) |>
                # 基线剔除已有抑郁（采用 <3 作为阈值）
                filter(!is.na(cesd_score), cesd_score < 3) |>
                # 只保留 R3FLONE 和 R3MSTATH 有效值
                filter(r3flone %in% c(0, 1), r3mstath %in% c(1, 3, 4, 5, 7, 8)) |>
                # Step 3: clean baseline character
                    # Exposure: loneliness 因子变量
                      mutate(
                              loneliness = factor(
                                r3flone,
                                levels = c(0, 1),
                                labels = c("Not lonely", "Lonely")
                              )
                            ) |>
                    # Exposure: social isolation
                      mutate(
                            unmarried_alone = case_when(
                              r3mstat %in% c(4, 5, 7, 8) ~ 1L,
                              r3mstat %in% c(1, 3)       ~ 0L,
                              TRUE                        ~ NA_integer_
                            ),
                            less_contact = case_when(
                              r3rfcntx_m %in% 6:9         ~ 1L,
                              r3rfcntx_m %in% 1:5         ~ 0L,
                              TRUE                        ~ NA_integer_
                            ),
                            no_social_participation = case_when(
                              r3relgwk == 0 | s3socact_m %in% 7:9         ~ 1L,
                              r3relgwk == 1 & s3socact_m %in% 1:6         ~ 0L,
                              TRUE                                        ~ NA_integer_
                            )
                          ) |>
                          # 计算社交隔离指数
                          rowwise() |>
                          mutate(
                            sum_valid = sum(c(unmarried_alone, less_contact, no_social_participation),
                                            na.rm = TRUE),
                            n_nonmiss = sum(!is.na(c(unmarried_alone, less_contact, no_social_participation))),
                            sum_valid = if_else(n_nonmiss == 0, NA_real_, sum_valid),
                            social_isolation = case_when(
                              is.na(sum_valid)      ~ NA_integer_,
                              sum_valid >= 1        ~ 1L,
                              sum_valid == 0        ~ 0L
                            ),
                            social_isolation = factor(social_isolation,levels = c(0, 1),
                                labels = c("No", "Yes"))
                          ) |>
                          ungroup() |>
                          # 清理临时变量
                          select(-less_contact, -no_social_participation,
                                 -sum_valid, -n_nonmiss) |>

                    # EMM: PA r3vigact
                      mutate(
                            vigor_pa = case_when(
                              r3vigact == 0 ~ 1,
                              r3vigact == 1 ~ 0,
                              TRUE   ~ NA_integer_
                              ),
                            vigor_pa = factor(
                            vigor_pa,
                            levels = c(0, 1),
                            labels = c("No", "Yes")
                          )
                            )|>
                          # 最终剔除 NA
                      # Education
                       mutate(
                        education= case_when(
                              raedisced %in% c(0, 1, 2) ~ 0,
                              raedisced==3      ~ 1,
                              raedisced %in% c(5, 6) ~ 2,
                              TRUE                        ~ NA_integer_
                            ),
                        education = factor(
                                education,
                                levels = c(0, 1, 2),
                                labels = c("Less than upper secondary", "Upper secondary", "Tertiary")
                              ))|>
                      # Employment status: Not working, Working, Retired:  r3lbrf_m
                        mutate(
                        employment = case_when(
                              r3lbrf_m %in% c(2, 4, 5, 6) ~ "Not working",
                              r3lbrf_m == 1 ~ "Working",
                              r3lbrf_m == 3 ~ "Retired",
                              TRUE          ~ NA_character_
                            ),
                        employment = factor(
                                            employment,
                                            levels = c("Not working","Working" , "Retired")
                                          )
                                    )|>
                      # BMI: r3bmi
                         mutate(
                          bmi = case_when(
                            r3bmi >= 30                    ~ "Obesity",
                            r3bmi >= 25 & r3bmi < 30       ~ "Overweight",
                            r3bmi < 25                     ~ "Underweight or healthy weight",
                            TRUE                           ~ NA_character_
                          ),
                          bmi = factor(
                                      bmi,
                                      levels = c("Underweight or healthy weight", "Overweight", "Obesity")
                                    )
                                  )|>
  
                      # Smoke 
                        # 先对 ever: r3smokev 和 now: r3smoken 
                        mutate(
                          smoke = factor(
                            case_when(
                              r3smoken == 1                           ~ "Current smoker",
                              r3smoken == 0 & r3smokev == 1           ~ "Past smoker",
                              r3smoken == 0 & r3smokev == 0           ~ "Non-smoker",
                              TRUE                                    ~ NA_character_
                            ),
                            levels = c("Non-smoker", "Past smoker", "Current smoker")
                          )
                        )|>
                      
                     # Alcohol consumption:  r3drink
                      mutate(
                        alcohol = factor(
                            case_when(
                              r3drink == 1            ~ "Yes",
                              r3drink == 0            ~ "No",
                              TRUE                    ~ NA_character_
                            ),
                            levels = c("No", "Yes")
                          )
                        )|>
                    # NCDs
                      mutate(
                        # 1. 将各 NCD 指标重编码为 0/1/NA
                        across(
                          .cols = c(r3hibpe, r3hrtatte, r3stroke, r3diabe, r3respe, r3cancre, r3arthre),
                          .fns  = ~ case_when(
                            .x == 1 ~ 1L,
                            .x == 0 ~ 0L,
                            TRUE    ~ NA_integer_
                          )
                        ),
                    
                        # 2. 计算 NCD 项目的总和（忽略 NA）
                        ncd_sum = rowSums(
                          across(
                            .cols = c(r3hibpe, r3hrtatte, r3stroke, r3diabe, r3respe, r3cancre, r3arthre),
                            .fns  = ~ .x
                          ),
                          na.rm = TRUE
                        ),
                    
                        # 3. 统计非缺失的 NCD 项目数量
                        ncd_non_missing = rowSums(
                          across(
                            .cols = c(r3hibpe, r3hrtatte, r3stroke, r3diabe, r3respe, r3cancre, r3arthre),
                            .fns  = ~ !is.na(.x)
                          )
                        ),
                    
                        # 4. 如果某行所有 NCD 都缺失，就把计数设 NA，否则用 ncd_sum
                        ncd_count = if_else(ncd_non_missing == 0, NA_real_, as.double(ncd_sum)),
                    
                        # 5. 构建最终因子：None vs “One or more”
                        NCDs = factor(
                          if_else(ncd_count >= 1, "One or more", "None"),
                          levels = c("None", "One or more")
                        )
                      )|>

                      filter(!is.na(social_isolation),
                             !is.na(vigor_pa),
                             !is.na(ragender),
                             !is.na(raedisced),
                             !is.na(unmarried_alone),
                             !is.na(education),
                             !is.na(employment),
                             !is.na(bmi),
                             !is.na(smoke),
                             !is.na(alcohol),
                             !is.na(NCDs)
                             )
dim(mhas_baseline)
```
## Follow-up
  
```{r}
mhas_follow_up = mhas |>
  # R4/R5 CES-D
    mutate(
       cesd_r4 = rowSums(cbind(
                          r4depres == 1, r4effort == 1, r4sleepr == 1,
                          r4whappy == 1, r4enlife == 1, r4fsad == 1,
                          r4ftired == 1), na.rm = FALSE),
       cesd_r5 = rowSums(cbind(
                          r5depres == 1, r5effort == 1, r5sleepr == 1,
                          r5whappy == 1, r5enlife == 1, r5fsad == 1,
                          r5ftired == 1 ), na.rm = FALSE),
    # define event
    event_r4 = as.integer(cesd_r4 >= 3),
    event_r5 = as.integer((cesd_r4 < 3 | is.na(cesd_r4)) & cesd_r5 >= 3),
    event = case_when(
    # 1. 只要 event_r5 是 NA，就把 event 设 NA
    is.na(event_r5)                                  ~ NA_integer_,
    # 2. 如果 event_r5 有值，且任一波次发生事件 → 1
    (coalesce(event_r4, 0L) == 1L) |
    (event_r5 == 1L)                                 ~ 1L,
    # 3. 其余（event_r5 有值且两波都没事件） → 0
    TRUE                                             ~ 0L
  ),
    
    #define event- time
      time = case_when(
        event_r4 == 1L  ~ 3,
        event_r5 == 1L  ~ 6,
        TRUE             ~ 6
      )
    ) |>
  select(rahhidnp,cesd_r4,cesd_r5,event_r4, event_r5, event,time )
  
```

```{r}
# Merge baseline and follow-up

mhas_cox = mhas_baseline|>
  mutate(
   marital_status = factor(unmarried_alone,
                           levels = c("1","0"),
                           labels = c("Single","Married or partnered")
                           )
  )|>
  select(
  rahhidnp,
  loneliness,
  social_isolation,
  vigor_pa,
  age = estimated_age_at_R3,
  sex = ragender,
  education,
  marital_status,
  employment,
  bmi,
  smoke,
  alcohol,
  NCDs
  )|>
inner_join(mhas_follow_up, by = "rahhidnp")|>
  drop_na(event)|>
  select(-cesd_r4,-cesd_r5,-event_r4, -event_r5 )


dim(mhas_cox)
```
2313 

## EDA

```{r}
mhas_data_std <- mhas_cox %>%
  rename(
    id          = rahhidnp,          # ELSA 里是 idauniq → id
    mar_status  = marital_status,     # Marital_status → mar_status
    smoking     = smoke,              # Smoke → smoking
    ncd         = NCDs,               # NCDs → ncd
    isolation   = social_isolation    # Social_isolation → isolation
    # 其它字段名已经和 ELSA 一致：age, sex, education,
    # employment, bmi, alcohol, loneliness,
    # vigor_pa, event, time
  ) %>%
  mutate(
    data_source = "MHAS",
    race = "non-White"
  )
write_csv(mhas_data_std, "./data/cleaned/MHAS_3_5_cox_renamed.csv")
```


```{r}
dataset_std = mhas_data_std
# 定义要包含在表中的变量
vars <- c("age", "sex", "race", "mar_status", "education", "employment", 
          "bmi", "smoking", "alcohol" ,"ncd","race" ,"isolation", "loneliness")

# 定义哪些变量为分类变量
categorical_vars <- c("isolation", "loneliness", "sex", "race", "mar_status", "education", "employment", 
                      "smoking", "alcohol", "ncd", "bmi")

# 创建 Table 1，假设 vigor_pa（这里统一为 inactivity）是分层变量
table1_generic <- CreateTableOne(
  vars = vars,
  strata = "vigor_pa",
  data = dataset_std,
  factorVars = categorical_vars
)
print(table1_generic)

# 提取为 data.frame
table_df <- print(table1_generic, quote = FALSE, noSpaces = TRUE, printToggle = FALSE)
# 然后写入 CSV
write_csv(as.data.frame(table_df), "./data/cleaned/MHAS_3_5_table1_generic.csv")

```

## Loneliness

### Cox model

```{r}
cox_model_lonely_raw <- coxph(Surv(time, event) ~ loneliness, data = dataset_std)

# 模型2：调整人口统计和健康相关协变量的 Cox 模型
cox_model_lonely_adj <- coxph(Surv(time, event) ~ loneliness + 
                                age + sex + mar_status + education + employment +
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)

# 模型3：调整vigor_pa、人口统计和健康相关协变量的 Cox 模型
cox_model_lonely_pi<- coxph(Surv(time, event) ~ loneliness + vigor_pa + 
                                age + sex + mar_status + education + employment+
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)


# 模型4：包含 loneliness 与 vigor_pa 交互项的 Cox 模型
cox_model_lonely_emm <- coxph(Surv(time, event) ~ loneliness * vigor_pa + 
                                age + sex + mar_status + education + employment+
                                bmi + smoking + alcohol + ncd,
                              data = dataset_std)
```


#### Model result (Forest values)
```{r}
# 模型1结果
summary_lonely_raw <- summary(cox_model_lonely_raw)
hr1 <- summary_lonely_raw$conf.int["lonelinessLonely", "exp(coef)"]
lower1 <- summary_lonely_raw$conf.int["lonelinessLonely", "lower .95"]
upper1 <- summary_lonely_raw$conf.int["lonelinessLonely", "upper .95"]
p1 <- summary_lonely_raw$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型2结果
summary_lonely_adj <- summary(cox_model_lonely_adj)
hr2 <- summary_lonely_adj$conf.int["lonelinessLonely", "exp(coef)"]
lower2 <- summary_lonely_adj$conf.int["lonelinessLonely", "lower .95"]
upper2 <- summary_lonely_adj$conf.int["lonelinessLonely", "upper .95"]
p2 <- summary_lonely_adj$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型3结果
summary_lonely_pi <- summary(cox_model_lonely_pi)
hr3 <- summary_lonely_pi$conf.int["lonelinessLonely", "exp(coef)"]
lower3 <- summary_lonely_pi$conf.int["lonelinessLonely", "lower .95"]
upper3 <- summary_lonely_pi$conf.int["lonelinessLonely", "upper .95"]
p3 <- summary_lonely_pi$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 模型4结果 - loneliness 主效应
summary_lonely_emm <- summary(cox_model_lonely_emm)
hr4 <- summary_lonely_emm$conf.int["lonelinessLonely", "exp(coef)"]
lower4 <- summary_lonely_emm$conf.int["lonelinessLonely", "lower .95"]
upper4 <- summary_lonely_emm$conf.int["lonelinessLonely", "upper .95"]
p4 <- summary_lonely_emm$coefficients["lonelinessLonely", "Pr(>|z|)"]

# 提取交互项效果（假设交互项名称为 "lonelinessLonely:vigor_paLow activity"，
# 表示当 vigor_pa 为 "Low activity" 时，loneliness 效应的额外修正）
interaction_term <- "lonelinessLonely:vigor_paYes"
interaction_coef <- summary_lonely_emm$coefficients[interaction_term, "coef"]
interaction_hr   <- summary_lonely_emm$conf.int[interaction_term, "exp(coef)"]
interaction_lower <- summary_lonely_emm$conf.int[interaction_term, "lower .95"]
interaction_upper <- summary_lonely_emm$conf.int[interaction_term, "upper .95"]
interaction_p     <- summary_lonely_emm$coefficients[interaction_term, "Pr(>|z|)"]


```

#### 【乘法交互】

```{r}
cat("交互项风险比 (exp(beta_interaction)) =", interaction_hr, "\n")
cat("95% CI: (", interaction_lower, ",", interaction_upper, ")\n")
cat("p 值:", interaction_p, "\n\n")
```

```{r}
###################################
## Additive interaction (RERI) 计算
###################################
# 提取相关系数（确保名称与模型输出一致）
beta_iso <- summary_lonely_emm$coefficients["lonelinessLonely", "coef"]       # loneliness 主效应
beta_pi  <- summary_lonely_emm$coefficients["vigor_paYes", "coef"]  # vigor_pa 主效应
beta_int <- interaction_coef                                                  # 交互项

# 计算各暴露组合下的风险比
HR10 <- exp(beta_iso)                            # loneliness alone (X=1, Z=0)
HR01 <- exp(beta_pi)                             # vigor_pa alone (X=0, Z=1)
HR11 <- exp(beta_iso + beta_pi + beta_int)         # 双重暴露 (X=1, Z=1)

RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
## 【加性交互 (RERI)】
cat("HR (loneliness only) =", HR10, "\n")
## HR (loneliness only) = 1.845765
cat("HR (physical inactivity only) =", HR01, "\n")
## HR (physical inactivity only) = 1.652779
cat("HR (both exposures) =", HR11, "\n")
## HR (both exposures) = 2.359524
cat("RERI =", RERI, "\n")
## RERI = -0.1390197
###################################
## 计算 RERI 的95% CI及 p 值（delta 方法）
###################################
# 获取模型协方差矩阵
V <- vcov(cox_model_lonely_emm)
# 按顺序提取相关参数协方差子矩阵（假定参数顺序为 loneliness, vigor_pa, 交互项）
param_names <- c("lonelinessLonely", "vigor_paYes", interaction_term)
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各参数的偏导数
d_beta <- c(
  exp(beta_iso + beta_pi + beta_int) - exp(beta_iso),  # dRERI/d(beta_iso)
  exp(beta_iso + beta_pi + beta_int) - exp(beta_pi),     # dRERI/d(beta_pi)
  exp(beta_iso + beta_pi + beta_int)                     # dRERI/d(beta_int)
)

Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\nRERI 的结果：\n")
## 
## RERI 的结果：
cat("RERI =", RERI, "\n")
## RERI = -0.1390197
cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")
## 95% CI: ( -0.5684211 , 0.2903818 )
cat("z =", z_RERI, "\n")
## z = -0.6345544
cat("p 值 =", p_RERI, "\n")
## p 值 = 0.5257191
```

```{r}
# 准备表格文本
tabletext <- cbind(
  c("Model", "Loneliness only", "Adjusted", "Adj + Physical inactivity", "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr1), " (", sprintf("%.2f", lower1), "-", sprintf("%.2f", upper1), ")"),
    paste0(sprintf("%.2f", hr2), " (", sprintf("%.2f", lower2), "-", sprintf("%.2f", upper2), ")"),
    paste0(sprintf("%.2f", hr3), " (", sprintf("%.2f", lower3), "-", sprintf("%.2f", upper3), ")"),
    paste0(sprintf("%.2f", hr4), " (", sprintf("%.2f", lower4), "-", sprintf("%.2f", upper4), ")")
  ),
  c("p-value",
    ifelse(p1 < 0.001, "<0.001", sprintf("%.3f", p1)),
    ifelse(p2 < 0.001, "<0.001", sprintf("%.3f", p2)),
    ifelse(p3 < 0.001, "<0.001", sprintf("%.3f", p3)),
    ifelse(p4 < 0.001, "<0.001", sprintf("%.3f", p4))
  )
)

forest_data <- data.frame(
  mean = c(NA, hr1, hr2, hr3, hr4),
  lower = c(NA, lower1, lower2, lower3, lower4),
  upper = c(NA, upper1, upper2, upper3, upper4)
)

mhas_loneliness_forestplot = forestplot(
  labeltext = tabletext,
  mean = forest_data$mean,
  lower = forest_data$lower,
  upper = forest_data$upper,
  is.summary = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  zero = 1,
  boxsize = 0.2,
  lineheight = "auto",
  col = fpColors(box = "royalblue", line = "darkblue", summary = "royalblue"),
  xlab = "Hazard Ratio (95% CI)",
  hrzl_lines = list("2" = gpar(lty = 2)),
  txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                   ticks = gpar(cex = 0.9),
                   xlab = gpar(cex = 1.2),
                   title = gpar(cex = 1.3)),
  title = "Association between Loneliness and Depression Risk"
)
mhas_loneliness_forestplot

```

```{r}
lrt_result <- anova(cox_model_lonely_pi, cox_model_lonely_emm, test = "LRT")
print(lrt_result)
```
## SSI

### Cox model

```{r}
# 模型1：仅包含 isolation 单变量 Cox 模型
cox_model_iso_raw <- coxph(Surv(time, event) ~ isolation, data = dataset_std)


# 模型2：调整协变量的 Cox 模型（不含身体活动）
cox_model_iso_adj <- coxph(Surv(time, event) ~ isolation + age + sex  + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = dataset_std)

# 模型3：在模型中加入 vigor_pa 作为协变量（调整模型中额外控制身体活动）
cox_model_iso_pi <- coxph(Surv(time, event) ~ isolation + vigor_pa + age + sex  + mar_status + education + employment +
                            bmi + smoking + alcohol + ncd,
                          data = dataset_std)

# 模型4：包含 isolation 与 vigor_pa 交互项的 Cox 模型
cox_model_iso_emm <- coxph(Surv(time, event) ~ isolation * vigor_pa + age + sex  + mar_status + education + employment +
                             bmi + smoking + alcohol + ncd,
                           data = dataset_std)
```


#### Model result (Forest values)
```{r}
# 提取模型1结果
summary_iso_raw <- summary(cox_model_iso_raw)
hr_iso1 <- summary_iso_raw$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "lower .95"]
upper_ci_iso1 <- summary_iso_raw$conf.int["isolationYes", "upper .95"]
p_val_iso1 <- summary_iso_raw$coefficients["isolationYes", "Pr(>|z|)"]

# 模型2结果
summary_iso_adj <- summary(cox_model_iso_adj)
hr_iso2 <- summary_iso_adj$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "lower .95"]
upper_ci_iso2 <- summary_iso_adj$conf.int["isolationYes", "upper .95"]
p_val_iso2 <- summary_iso_adj$coefficients["isolationYes", "Pr(>|z|)"]

# 模型3结果
summary_iso_pi <- summary(cox_model_iso_pi)
hr_iso3 <- summary_iso_pi$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "lower .95"]
upper_ci_iso3 <- summary_iso_pi$conf.int["isolationYes", "upper .95"]
p_val_iso3 <- summary_iso_pi$coefficients["isolationYes", "Pr(>|z|)"]

# 模型4结果 - isolation 主效应
summary_iso_emm <- summary(cox_model_iso_emm)
hr_iso4 <- summary_iso_emm$conf.int["isolationYes", "exp(coef)"]
lower_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "lower .95"]
upper_ci_iso4 <- summary_iso_emm$conf.int["isolationYes", "upper .95"]
p_val_iso4 <- summary_iso_emm$coefficients["isolationYes", "Pr(>|z|)"]

# 交互项效果提取（假设交互项名称为 "isolationYes:vigor_paLow activity"，
# 表示当 vigor_pa 为 "Low activity" 时，isolation 的额外修正）
interaction_term_iso <- "isolationYes:vigor_paYes"
interaction_coef_iso <- summary_iso_emm$coefficients[interaction_term_iso, "coef"]
interaction_hr_iso   <- summary_iso_emm$conf.int[interaction_term_iso, "exp(coef)"]
interaction_lower_iso <- summary_iso_emm$conf.int[interaction_term_iso, "lower .95"]
interaction_upper_iso <- summary_iso_emm$conf.int[interaction_term_iso, "upper .95"]
interaction_p_iso     <- summary_iso_emm$coefficients[interaction_term_iso, "Pr(>|z|)"]




```

#### 【乘法交互】

```{r}
######################################
## Multiplicative interaction
######################################
cat("【乘法交互】\n")
## 【乘法交互】
cat("交互项风险比 (exp(beta_interaction)) =", interaction_hr_iso, "\n")
## 交互项风险比 (exp(beta_interaction)) = 1.100757
cat("95% CI: (", interaction_lower_iso, ",", interaction_upper_iso, ")\n")
## 95% CI: ( 0.8765557 , 1.382305 )
cat("p 值:", interaction_p_iso, "\n\n")
## p 值: 0.4087312
```

#### Additive interaction (RERI)

```{r}
###################################
## Additive interaction (RERI) 计算
###################################
# 提取相关系数（确保名称与模型输出一致）
beta_iso <- summary_iso_emm$coefficients["isolationYes", "coef"]      # isolation 主效应
beta_pi  <- summary_iso_emm$coefficients["vigor_paYes", "coef"]             # vigor_pa 主效应
beta_int <- interaction_coef_iso                                                    # 交互项

# 计算各种暴露组合下的风险比
HR10 <- exp(beta_iso)                       # isolation alone (when vigor_pa = 0)
HR01 <- exp(beta_pi)                        # vigor_pa alone (when isolation = 0)
HR11 <- exp(beta_iso + beta_pi + beta_int)    # both exposures (isolation and vigor_pa)

# RERI 计算公式
RERI <- HR11 - HR10 - HR01 + 1

cat("【加性交互 (RERI)】\n")
## 【加性交互 (RERI)】
cat("HR (isolation only) =", HR10, "\n")
## HR (isolation only) = 1.068376
cat("HR (physical inactivity only) =", HR01, "\n")
## HR (physical inactivity only) = 1.415559
cat("HR (both exposures) =", HR11, "\n")
## HR (both exposures) = 1.66473
cat("RERI =", RERI, "\n")
## RERI = 0.1807948
######################################
## 计算 RERI 的95% CI和 p 值（delta方法）
######################################
# 获取交互模型中相关系数的协方差矩阵
V <- vcov(cox_model_iso_emm)
# 提取相关参数的协方差子矩阵，按顺序为 isolation, vigor_pa, 交互项
param_names <- c("isolationYes", "vigor_paYes", interaction_term_iso)
V_sub <- V[param_names, param_names]

# 计算 RERI 关于各个参数的偏导数
# dRERI/dβ_iso = exp(β_iso + β_pi + β_int) - exp(β_iso)
# dRERI/dβ_pi  = exp(β_iso + β_pi + β_int) - exp(β_pi)
# dRERI/dβ_int = exp(β_iso + β_pi + β_int)
d_beta <- c(
  exp(beta_iso + beta_pi + beta_int) - exp(beta_iso),
  exp(beta_iso + beta_pi + beta_int) - exp(beta_pi),
  exp(beta_iso + beta_pi + beta_int)
)

# 计算 RERI 的方差：Var(RERI) = d_beta' * V_sub * d_beta
Var_RERI <- as.numeric(t(d_beta) %*% V_sub %*% d_beta)
SE_RERI <- sqrt(Var_RERI)

# 计算95% CI
RERI_lower <- RERI - 1.96 * SE_RERI
RERI_upper <- RERI + 1.96 * SE_RERI

# 计算针对 RERI 的 z 统计量和 p 值
z_RERI <- RERI / SE_RERI
p_RERI <- 2 * (1 - pnorm(abs(z_RERI)))

cat("\nRERI 的结果：\n")
cat("RERI =", RERI, "\n")

cat("95% CI: (", RERI_lower, ",", RERI_upper, ")\n")

cat("z =", z_RERI, "\n")

cat("p 值 =", p_RERI, "\n")

```

```{r}
# 准备表格文本
tabletext_iso <- cbind(
  c("Model", "Isolation only", "Adjusted", "Adj + PI", "Interaction model"),
  c("HR (95% CI)",
    paste0(sprintf("%.2f", hr_iso1), " (", sprintf("%.2f", lower_ci_iso1), "-", sprintf("%.2f", upper_ci_iso1), ")"),
    paste0(sprintf("%.2f", hr_iso2), " (", sprintf("%.2f", lower_ci_iso2), "-", sprintf("%.2f", upper_ci_iso2), ")"),
    paste0(sprintf("%.2f", hr_iso3), " (", sprintf("%.2f", lower_ci_iso3), "-", sprintf("%.2f", upper_ci_iso3), ")"),
    paste0(sprintf("%.2f", hr_iso4), " (", sprintf("%.2f", lower_ci_iso4), "-", sprintf("%.2f", upper_ci_iso4), ")")
  ),
  c("p-value",
    ifelse(p_val_iso1 < 0.001, "<0.001", sprintf("%.3f", p_val_iso1)),
    ifelse(p_val_iso2 < 0.001, "<0.001", sprintf("%.3f", p_val_iso2)),
    ifelse(p_val_iso3 < 0.001, "<0.001", sprintf("%.3f", p_val_iso3)),
    ifelse(p_val_iso4 < 0.001, "<0.001", sprintf("%.3f", p_val_iso4))
  )
)

forest_data_iso <- data.frame(
  mean = c(NA, hr_iso1, hr_iso2, hr_iso3, hr_iso4),
  lower = c(NA, lower_ci_iso1, lower_ci_iso2, lower_ci_iso3, lower_ci_iso4),
  upper = c(NA, upper_ci_iso1, upper_ci_iso2, upper_ci_iso3, upper_ci_iso4)
)

mhas_ssi_forestplot= forestplot(
  labeltext = tabletext_iso,
  mean = forest_data_iso$mean,
  lower = forest_data_iso$lower,
  upper = forest_data_iso$upper,
  is.summary = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  zero = 1,
  boxsize = 0.2,
  lineheight = "auto",
  col = fpColors(box = "royalblue", line = "darkblue", summary = "royalblue"),
  xlab = "Hazard Ratio (95% CI)",
  hrzl_lines = list("2" = gpar(lty = 2)),
  txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                   ticks = gpar(cex = 0.9),
                   xlab = gpar(cex = 1.2),
                   title = gpar(cex = 1.3)),
  title = "Association between Social Isolation and Depression Risk"
)
mhas_ssi_forestplot
```




# Pool
```{r}
head(mhas_data_std,2)
head(elsa_data_std,2)
head(hrs_data_std,2)
```
, ,
```{r}
str(mhas_data_std$sex)
str(elsa_data_std$sex)
str(hrs_data_std$sex)
```

```{r}
# 1. 定义你想要保留并统一顺序的列向量
mhas_data_std=mhas_data_std|>
  mutate(
    sex = factor(sex,
      levels = c(1, 2),
      labels = c("Male", "Female")
    )
  )
elsa_data_std=elsa_data_std|>
  mutate(
    sex = factor(sex,
      levels = c(1, 2),
      labels = c("Male", "Female")
    )
  )

desired_cols <- c(
  "id",
  "loneliness",
  "isolation",
  "vigor_pa",
  "age",
  "sex",
  "education",
  "mar_status",
  "employment",
  "bmi",
  "smoking",
  "alcohol",
  "ncd",
  "race",
  "time",
  "event",
  "data_source"
)

# 2. 对每个数据集进行选列并按照 desired_cols 排序
mhas_std2 <- mhas_data_std[ , desired_cols]
elsa_std2 <- elsa_data_std[ , desired_cols]
hrs_std2  <- hrs_data_std[ , desired_cols]

# （如果列中有不存在的名字，R 会报错——你可以先检查一下）
stopifnot(all(desired_cols %in% colnames(mhas_data_std)))
stopifnot(all(desired_cols %in% colnames(elsa_data_std)))
stopifnot(all(desired_cols %in% colnames(hrs_data_std)))

# 3. 按行合并
combined_df <- rbind(mhas_std2, elsa_std2, hrs_std2)

# 4. 检查
str(combined_df)
table(combined_df$data_source)
```
## EDA
```{r}
dataset_std = combined_df
# 定义要包含在表中的变量
vars <- c("age", "sex", "race", "mar_status", "education", "employment", 
          "bmi", "smoking", "alcohol" ,"ncd","isolation", "loneliness","data_source")

# 定义哪些变量为分类变量
categorical_vars <- c("isolation", "loneliness", "sex", "race", "mar_status", "education", "employment", 
                      "smoking", "alcohol", "ncd", "bmi","data_source")

# 创建 Table 1，假设 vigor_pa（这里统一为 inactivity）是分层变量
table1_generic <- CreateTableOne(
  vars = vars,
  strata = "vigor_pa",
  data = dataset_std,
  factorVars = categorical_vars,
  addOverall = T
)
print(table1_generic)
```
```{r}
#Power calculation
# —— 1. 准备：从 combined_df 提取事件数和暴露比例 —— 
# 这里以 loneliness 为例；如果算 isolation，把下面两行中的变量名改成 isolation=="Yes"
E           <- sum(combined_df$event)  
p_exposed   <- mean(combined_df$loneliness == "Lonely")

# —— 2. 选择你要评估的 HR —— 
# 例如，用模型4 中 loneliness 的主效应 HR（你之前提取的 hr4_pooled）
hr_obs      <- hr4_pooled

# —— 3. Schoenfeld 近似计算 power —— 
alpha       <- 0.05
z_alpha2    <- qnorm(1 - alpha / 2)

z_beta      <- sqrt(E * p_exposed * (1 - p_exposed)) * abs(log(hr_obs)) - z_alpha2
power_est   <- pnorm(z_beta)

# —— 4. 输出结果 —— 
cat("事件总数 E =", E, "\n")
cat("暴露比例 p =", round(p_exposed, 3), "\n")
cat("观察到的 HR =", round(hr_obs, 3), "\n\n")
cat("估算的检验效能 (power) =", round(power_est, 3), "\n")


```
```{r}

E           <- sum(combined_df$event)  
p_exposed   <- mean(combined_df$isolation == "Yes")
hr_obs      <- 1.065    # 你提取的 isolation 模型4 的主效应 HR

# 其余代码同上
alpha       <- 0.05
z_alpha2    <- qnorm(1 - alpha / 2)
z_beta      <- sqrt(E * p_exposed * (1 - p_exposed)) * abs(log(hr_obs)) - z_alpha2
power_est   <- pnorm(z_beta)

cat("事件总数 E =", E, "\n")
cat("暴露比例 p =", round(p_exposed, 3), "\n")
cat("观察到的 HR =", round(hr_obs, 3), "\n\n")
cat("估算的检验效能 (power) =", round(power_est, 3), "\n")
```



```{r}

# 模型1：仅包含 loneliness 单变量 Cox 模型
cox_pooled_lonely_raw <- coxme(Surv(time, event) ~ loneliness + (1 | data_source), data = combined_df)
# 模型2：调整人口统计和健康相关协变量的 Cox 模型
cox_pooled_lonely_adj  <- coxme(Surv(time, event) ~ loneliness + 
                           age + sex  + mar_status + education + employment +
                           bmi + smoking + alcohol + ncd + (1 | data_source),
                           data = combined_df)
# 模型3：调整vigor_pa、人口统计和健康相关协变量的 Cox 模型
cox_pooled_lonely_pi <- coxme(Surv(time, event) ~ loneliness + vigor_pa + 
                           age + sex + mar_status + education + employment +
                           bmi + smoking + alcohol + ncd + (1 | data_source),
                           data = combined_df)
# 模型4：包含 loneliness 与 vigor_pa 交互项的 Cox 模型
cox_pooled_lonely_emm <- coxme(Surv(time, event) ~ loneliness * vigor_pa + 
                           age + sex  + mar_status + education + employment +
                           bmi + smoking + alcohol + ncd + (1 | data_source),
                           data = combined_df)
```

```{r}
# 模型1结果
summary_lonely_raw_pooled <- summary(cox_pooled_lonely_raw)
hr1_pooled <- summary_lonely_adj$coefficients["lonelinessLonely", "exp(coef)"]
p1_pooled <- summary_lonely_raw$coefficients["lonelinessLonely", "p"]

# 模型2结果
summary_lonely_adj_pooled <- summary(cox_pooled_lonely_adj)
hr2_pooled <- summary_lonely_adj$coefficients["lonelinessLonely", "exp(coef)"]
p2_pooled <- summary_lonely_adj$coefficients["lonelinessLonely", "p"]

# 模型3结果
summary_lonely_pi_pooled <- summary(cox_pooled_lonely_pi)
hr3_pooled <- summary_lonely_pi$coefficients["lonelinessLonely", "exp(coef)"]
p3_pooled <- summary_lonely_pi$coefficients["lonelinessLonely", "p"]

# 模型4结果 - loneliness 主效应
summary_lonely_emm_pooled <- summary(cox_pooled_lonely_emm)
hr4_pooled <- summary_lonely_emm$coefficients["lonelinessLonely", "exp(coef)"]
p4_pooled <- summary_lonely_emm$coefficients["lonelinessLonely", "p"]

# 提取交互项效果（假设交互项名称为 "lonelinessLonely:vigor_paLow activity"，
# 表示当 vigor_pa 为 "Low activity" 时，loneliness 效应的额外修正）
interaction_term_pooled <- "lonelinessLonely:vigor_paYes"
interaction_coef_pooled <- summary_lonely_emm_pooled$coefficients[interaction_term, "coef"]
interaction_hr_pooled   <- summary_lonely_emm_pooled$coefficients[interaction_term, "exp(coef)"]
interaction_p_pooled     <- summary_lonely_emm_pooled$coefficients[interaction_term, "p"]

```

```{r}
###################################
## Multiplicative interaction
###################################
cat("【乘法交互】\n")
## 【乘法交互】
cat("交互项风险比 (exp(beta_interaction)) =", interaction_hr_pooled, "\n")
## 交互项风险比 (exp(beta_interaction)) = 0.7734518

## 95% CI: ( 0.6187645 , 0.96681 )
cat("p 值:", interaction_p_pooled, "\n\n")
```

```{r}
###################################
## Additive interaction (RERI) 计算
###################################
# 提取相关系数（确保名称与模型输出一致）
beta_iso_pooled <- summary_lonely_emm_pooled$coefficients["lonelinessLonely", "coef"]       # loneliness 主效应
beta_pi_pooled  <- summary_lonely_emm_pooled$coefficients["vigor_paYes", "coef"]  # vigor_pa 主效应
beta_int_pooled <- interaction_coef_pooled                                                  # 交互项

# 计算各暴露组合下的风险比
HR10_pooled <- exp(beta_iso_pooled)                            # loneliness alone (X=1, Z=0)
HR01_pooled <- exp(beta_pi_pooled)                             # vigor_pa alone (X=0, Z=1)
HR11_pooled <- exp(beta_iso_pooled + beta_pi_pooled + beta_int_pooled)         # 双重暴露 (X=1, Z=1)

RERI_pooled <- HR11_pooled - HR10_pooled - HR01_pooled + 1

cat("【加性交互 (RERI)】\n")
## 【加性交互 (RERI)】
cat("HR (loneliness only) =", HR10_pooled, "\n")
## HR (loneliness only) = 1.845765
cat("HR (physical inactivity only) =", HR01_pooled, "\n")
## HR (physical inactivity only) = 1.652779
cat("HR (both exposures) =", HR11_pooled, "\n")
## HR (both exposures) = 2.359524
cat("RERI =", RERI_pooled, "\n")
## RERI = -0.1390197
###################################
## 计算 RERI 的95% CI及 p 值（delta 方法）
###################################
# 获取模型协方差矩阵
V_pooled <- vcov(cox_pooled_lonely_emm)
# 按顺序提取相关参数协方差子矩阵（假定参数顺序为 loneliness, vigor_pa, 交互项）
param_names_pooled <- c("lonelinessLonely", "vigor_paYes", interaction_term_pooled)
V_sub_pooled <- V[param_names_pooled, param_names_pooled]

# 计算 RERI 关于各参数的偏导数
d_beta_pooled <- c(
  exp(beta_iso_pooled + beta_pi_pooled + beta_int_pooled) - exp(beta_iso_pooled),  # dRERI/d(beta_iso)
  exp(beta_iso_pooled + beta_pi_pooled + beta_int_pooled) - exp(beta_pi_pooled),     # dRERI/d(beta_pi)
  exp(beta_iso_pooled + beta_pi_pooled + beta_int_pooled)                     # dRERI/d(beta_int)
)

Var_RERI_pooled <- as.numeric(t(d_beta_pooled) %*% V_sub_pooled %*% d_beta_pooled)
SE_RERI_pooled <- sqrt(Var_RERI_pooled)

RERI_lower_pooled <- RERI_pooled - 1.96 * SE_RERI_pooled
RERI_upper_pooled <- RERI_pooled + 1.96 * SE_RERI_pooled

z_RERI_pooled <- RERI_pooled / SE_RERI_pooled
p_RERI_pooled <- 2 * (1 - pnorm(abs(z_RERI_pooled)))

cat("\nRERI 的结果：\n")
## 
## RERI 的结果：
cat("RERI =", RERI_pooled, "\n")
## RERI = -0.1390197
cat("95% CI: (", RERI_lower_pooled, ",", RERI_upper_pooled, ")\n")
## 95% CI: ( -0.5684211 , 0.2903818 )
cat("z =", z_RERI_pooled, "\n")
## z = -0.6345544
cat("p 值 =", p_RERI_pooled, "\n")
```

```{r}
# 1. 拟合四个 pooled mixed‐effects Cox 模型
library(coxme)

# 模型1：仅包含 isolation 主效应
cox_pooled_iso_raw <- coxme(
  Surv(time, event) ~ isolation + (1 | data_source),
  data = combined_df
)

# 模型2：调整人口统计和健康协变量
cox_pooled_iso_adj <- coxme(
  Surv(time, event) ~ isolation +
    age + sex + mar_status + education + employment +
    bmi + smoking + alcohol + ncd +
    (1 | data_source),
  data = combined_df
)

# 模型3：再加上 vigor_pa 主效应
cox_pooled_iso_pi <- coxme(
  Surv(time, event) ~ isolation + vigor_pa +
    age + sex + mar_status + education + employment +
    bmi + smoking + alcohol + ncd +
    (1 | data_source),
  data = combined_df
)

# 模型4：加上 isolation × vigor_pa 交互
cox_pooled_iso_emm <- coxme(
  Surv(time, event) ~ isolation * vigor_pa +
    age + sex + mar_status + education + employment +
    bmi + smoking + alcohol + ncd +
    (1 | data_source),
  data = combined_df
)


```


```{r}

# 2. 提取各模型的 HR 和 p‐value
# --------------------------------------------------
# 模型1 结果
sum_iso_raw_p <- summary(cox_pooled_iso_raw)
hr1_pooled <-  sum_iso_raw_p$coefficients["isolationYes","exp(coef)"]
p1_pooled  <-  sum_iso_raw_p$coefficients["isolationYes","p"]

# 模型2 结果
sum_iso_adj_p <- summary(cox_pooled_iso_adj)
hr2_pooled    <- sum_iso_adj_p$coefficients["isolationYes","exp(coef)"]
p2_pooled     <- sum_iso_adj_p$coefficients["isolationYes","p"]

# 模型3 结果
sum_iso_pi_p  <- summary(cox_pooled_iso_pi)
hr3_pooled    <- sum_iso_pi_p$coefficients["isolationYes","exp(coef)"]
p3_pooled     <- sum_iso_pi_p$coefficients["isolationYes","p"]

# 模型4 结果（主效应部分）
sum_iso_emm_p <- summary(cox_pooled_iso_emm)
hr4_pooled    <- sum_iso_emm_p$coefficients["isolationYes","exp(coef)"]
p4_pooled     <- sum_iso_emm_p$coefficients["isolationYes","p"]

# 提取交互项（假设 factor level 名称是 isolationYes:vigor_paYes）
interaction_term_iso <- "isolationYes:vigor_paYes"
interaction_coef_p  <- sum_iso_emm_p$coefficients[interaction_term_iso, "coef"]
interaction_hr_p    <- sum_iso_emm_p$coefficients[interaction_term_iso, "exp(coef)"]
interaction_p_p     <- sum_iso_emm_p$coefficients[interaction_term_iso, "p"]



```

```{r}
# 3. Multiplicative interaction 输出
cat("【乘法交互】\n")
cat("交互项 HR (exp(beta)) =", sprintf("%.3f", interaction_hr_p), "\n")
cat("p 值 =", sprintf("%.3f", interaction_p_p), "\n\n")


# 4. Additive interaction (RERI) 计算
# --------------------------------------------------
# 提取三个系数
beta_iso_p   <- sum_iso_emm_p$coefficients["isolationYes", "coef"]
beta_pi_p    <- sum_iso_emm_p$coefficients["vigor_paYes", "coef"]
beta_int_p   <- interaction_coef_p

# 计算单、双暴露下的 HR
HR10 <- exp(beta_iso_p)                              # isolation only
HR01 <- exp(beta_pi_p)                               # phys_inactivity only
HR11 <- exp(beta_iso_p + beta_pi_p + beta_int_p)     # both

# 计算 RERI
RERI <- HR11 - HR10 - HR01 + 1

# delta 方法估算标准误和置信区间
V   <- vcov(cox_pooled_iso_emm)
params <- c("isolationYes", "vigor_paYes", interaction_term_iso)
V_sub  <- V[params, params]

# RERI 对各 beta 的偏导数
dR_dbetas <- c(
  exp(beta_iso_p + beta_pi_p + beta_int_p) - exp(beta_iso_p),
  exp(beta_iso_p + beta_pi_p + beta_int_p) - exp(beta_pi_p),
  exp(beta_iso_p + beta_pi_p + beta_int_p)
)

Var_RERI <- as.numeric(t(dR_dbetas) %*% V_sub %*% dR_dbetas)
SE_RERI  <- sqrt(Var_RERI)

CI_lower <- RERI - 1.96 * SE_RERI
CI_upper <- RERI + 1.96 * SE_RERI

z_val    <- RERI / SE_RERI
p_RERI   <- 2 * (1 - pnorm(abs(z_val)))

# 打印结果
cat("【加性交互 (RERI)】\n")
cat("HR (isolation only) =", sprintf("%.3f", HR10), "\n")
cat("HR (physical inactivity only) =", sprintf("%.3f", HR01), "\n")
cat("HR (both) =", sprintf("%.3f", HR11), "\n")
cat("RERI =", sprintf("%.3f", RERI), "\n")
cat("95% CI: (", sprintf("%.3f", CI_lower), ",", sprintf("%.3f", CI_upper), ")\n")
cat("z =", sprintf("%.3f", z_val), "  p =", sprintf("%.3f", p_RERI), "\n")

```
```{r}

library(car)
linear_model <- lm(as.numeric(event) ~ combined_df$isolation + vigor_pa + 
                           age + sex + mar_status + education + employment +
                           bmi + smoking + alcohol + ncd ,
                           data = combined_df)

vif(linear_model)
```





# Meta analysis

## Loneliness

### main effect
```{r}
library(metafor)
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.78,1.76 ,1.34 ),         
  Upper = c(1.92, 1.93, 1.59)  ,
  Lower = c(1.65,1.60 , 1.13)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```

### RERI
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.01,0.77 ,1.08 ),         
  Upper = c(1.21, 0.97, 1.53)  ,
  Lower = c(0.85,0.62 , 0.76)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```

### Multiplicative interaction
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.01,0.77 ,1.08 ),         
  Upper = c(1.21, 0.97, 1.53)  ,
  Lower = c(0.85,0.62 , 0.76)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```


## Loneliness

### main effect
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.01,0.77 ,1.08 ),         
  Upper = c(1.21, 0.97, 1.53)  ,
  Lower = c(0.85,0.62 , 0.76)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```

### RERI
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.01,0.77 ,1.08 ),         
  Upper = c(1.21, 0.97, 1.53)  ,
  Lower = c(0.85,0.62 , 0.76)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```

### SSI
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(0.89,1.10 ,0.84 ),         
  Upper = c(1.07, 1.38, 1.17)  ,
  Lower = c(0.75,0.88 , 0.61)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```

```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```


## main effect
```{r}
meta_data <- data.frame(
  study = c("HRS", "ELSA", "MHAS"),
  HR = c(1.04,1.03, 1.09 ),         
  Upper = c(1.13, 1.12, 1.29)  ,
  Lower = c(0.95,0.95 , 0.92)
  
)

meta_data$logHR <- log(meta_data$HR)
meta_data$SE <- (log(meta_data$Upper) - log(meta_data$Lower)) / (2 * 1.96)
```

```{r}
# Random-effects model using REML
res <- rma(yi = logHR, sei = SE, data = meta_data, method = "REML")

# 显示结果
summary(res)

```
```{r}

cat("I² =", res$I2, "%\n")
cat("τ² =", res$tau2, "\n")
cat("Q-test p-value =", res$QEp, "\n")
```
```